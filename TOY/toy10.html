<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Toastmasters Club Dashboard</title>

<!-- Libs -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --tm-navy:#004165; --tm-gold:#F2DF74; --tm-burgundy:#772432; --tm-blue:#1C6BA0;
    --card:#fff; --bg:#f6f8fb; --muted:#667085;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#1d2939}
  header{background:var(--tm-navy);color:#fff;display:flex;align-items:center;gap:12px;padding:16px}
  header img{height:40px}
  header h1{margin:0;font-size:18px;font-weight:700}

  .container{max-width:1200px;margin:22px auto;padding:0 14px}
  h2{color:var(--tm-navy);margin:20px 0 10px}
  h3{margin:16px 0 8px;color:var(--tm-navy)}

  .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,.08);padding:14px}
  .grid{display:grid;gap:14px}
  .grid-2{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .grid-3{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}

  .kpi{border:1px solid #e5e7eb;border-radius:12px;padding:10px;text-align:center}
  .kpi h3{margin:3px 0 2px;font-size:22px;color:var(--tm-burgundy)}
  .kpi p{margin:0;color:var(--muted);font-size:13px}

  .profile{display:flex;align-items:center;gap:12px}
  .avatar{height:48px;width:48px;border-radius:50%;display:grid;place-items:center;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--tm-blue),var(--tm-burgundy))}
  .muted{color:var(--muted);font-size:13px}

  .field{display:flex;flex-direction:column;gap:6px}
  select,input[type=date]{padding:9px 12px;border:1px solid #d0d5dd;border-radius:10px;background:#fff;min-width:220px}

  .tabs{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
  .tabs button{flex:1;padding:8px 10px;border:1px solid #d0d5dd;border-radius:10px;background:#fff;cursor:pointer}
  .tabs button.active{background:var(--tm-blue);color:#fff;font-weight:600}
  .tab-content{display:none}
  .tab-content.active{display:block}

  .table-container{overflow-x:auto}
  .dataTables_wrapper{overflow-x:auto}
  table.dataTable thead th{background:var(--tm-navy);color:#fff}

  .chart-container{position:relative;width:100%;min-height:240px;overflow-x:auto}
  canvas{width:100%!important;height:auto!important;max-height:360px;background:#fff;border-radius:12px;padding:8px}

  footer{margin:22px 0;color:var(--muted);text-align:center;font-size:12px}

  @media(max-width:600px){
    header h1{font-size:14px}
    .kpi h3{font-size:18px}
  }
</style>
</head>
<body>
<header>
  <img alt="Toastmasters" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Toastmasters_International_2011_Logo.svg/320px-Toastmasters_International_2011_Logo.svg.png">
  <h1>Toastmasters of the Year — Club Dashboard</h1>
</header>

<div class="container">
  <!-- Leaderboard -->
  <h2>Leaderboard (Summary)</h2>
  <div class="card">
    <div class="table-container">
      <table id="leaderboard" class="display" style="width:100%"></table>
    </div>
    <p class="muted">Tip: click a member to open their profile, or use the dropdown.</p>
  </div>

  <!-- Profile -->
  <h2>Member Profile</h2>
  <div class="card">
    <div class="profile" style="margin-bottom:10px">
      <div class="avatar" id="avatar">TM</div>
      <div>
        <div id="profileName" style="font-weight:700;font-size:18px">Select a member</div>
        <div id="profileSub" class="muted">—</div>
      </div>
    </div>

    <!-- Member selector -->
    <div class="field" style="margin-bottom:10px">
      <label for="memberSelect">Choose member</label>
      <select id="memberSelect"><option value="">Loading...</option></select>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="kpiTab">KPIs</button>
      <button class="tab-btn" data-tab="chartTab">Charts</button>
      <button class="tab-btn" data-tab="detailTab">Details</button>
      <button class="tab-btn" data-tab="filterTab">Filters</button>
      <button class="tab-btn" data-tab="clubTab">Club Stats</button>
    </div>

    <!-- KPI tab -->
    <div id="kpiTab" class="tab-content active">
      <div class="grid grid-3" style="margin-top:8px">
        <div class="kpi"><h3 id="meetingsCount">0</h3><p>Meetings (Filtered)</p></div>
        <div class="kpi"><h3 id="totalPointsAll">0</h3><p>Total Points (Official)</p></div>
        <div class="kpi"><h3 id="filteredPoints">0</h3><p>Points (Filtered, Weighted)</p></div>
        <div class="kpi"><h3 id="distinctRoles">0</h3><p>Distinct Roles (Filtered)</p></div>
      </div>
    </div>

    <!-- Charts tab -->
    <div id="chartTab" class="tab-content">
      <div class="grid grid-2">
        <div class="chart-container"><canvas id="categoryChart"></canvas></div>
        <div class="chart-container"><canvas id="progressChart"></canvas></div>
      </div>
    </div>

    <!-- Details tab -->
    <div id="detailTab" class="tab-content">
      <div class="table-container">
        <table id="detailTable" class="display" style="width:100%"></table>
      </div>
    </div>

    <!-- Filters tab -->
    <div id="filterTab" class="tab-content">
      <div class="grid grid-3">
        <div class="field">
          <label for="roleFilter">Role</label>
          <select id="roleFilter"><option value="">All roles</option></select>
        </div>
        <div class="field">
          <label for="startDate">Start date</label>
          <input id="startDate" type="date">
        </div>
        <div class="field">
          <label for="endDate">End date</label>
          <input id="endDate" type="date">
        </div>
      </div>
      <p class="muted" style="margin-top:6px">Filters affect both the Member Charts/Details and the Club Stats.</p>
    </div>

    <!-- Club-wide tab -->
    <div id="clubTab" class="tab-content">
      <div class="grid grid-2">
        <div class="chart-container"><canvas id="clubRoleChart"></canvas></div>
        <div class="chart-container"><canvas id="clubProgressChart"></canvas></div>
      </div>
      <p class="muted" id="clubTotalsNote" style="margin-top:6px">—</p>
    </div>
  </div>
</div>

<footer>Responsive Toastmasters dashboard — live data from Google Sheets CSV.</footer>

<script>
/* ---------- CSV Endpoints (original, working) ---------- */
const SHEETS = {
  Summary: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1556398249&single=true&output=csv",
  Total: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1939085341&single=true&output=csv",
  EarlyAttendance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1928408168&single=true&output=csv",
  RoleTaking: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=23380471&single=true&output=csv",
  LastMinuteRoles: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=10890228&single=true&output=csv",
  Speeches: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=170161438&single=true&output=csv",
  Evaluations: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=335593996&single=true&output=csv",
  LevelCompletions: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1646576393&single=true&output=csv",
  Awards: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=302763050&single=true&output=csv",
  ExComSub: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=710668362&single=true&output=csv",
  Contests: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=859627444&single=true&output=csv",
  TableTopics: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=618267332&single=true&output=csv"
};

/* ---------- Point Rules (original) ---------- */
const POINT_RULES = {
  earlyAttendance: v => (v === "E0" ? 1 : 0),
  roles: {"MC":3,"GE":2,"TTM":2,"Timer":1,"Ah Counter":1,"Grammarian":1,"Listener":1,"Evaluator":2,"Evaluators' Evaluator":1},
  speech: 3,
  evaluationTrue: 2,
  awards: {"Best Speaker":2,"Best Evaluator":1,"Best TT":1,"Best Table Topics":1,"Best Role Taker":2},
  levels: {"Level 1":5,"Level 2":6,"Level 3":7,"Level 4":8,"Level 5":9,"DTM":15},
  excom: {
    "Club Officer":12,"Area Director":17,"Division Director":22,
    "Club Growth Director":27,"Program Quality Director":32,"District Director":37,
    "Member of DD/PQD/CGD/PRM Teams":6,"Subcommittee member":6
  },
  contestBase: {"Table Topics":1,"Evaluation":1,"Humorous":2,"International":3,"Contest Chair":4,"Contest Role Taker":2},
  placement: {"1st":4,"2nd":3,"3rd":2},
  external: {
    "Event Chair (Physical)":10,"Event Chair (Online)":8,
    "Head of Education (Physical)":9,"Head of Education (Online)":7,
    "Head of PR (Physical)":8,"Head of PR (Online)":6,
    "Head of Logistics (Physical)":8,"Head of Logistics (Online)":5,
    "Head of IT (Physical)":6,"Head of IT (Online)":5,
    "Facilitator (Physical)":7,"Facilitator (Online)":5,
    "DTAC Head of Committee":13,"DTAC Committee Member":6,"DTAC Role Taker":4,
    "External Lead (ExCom Approved)":3,"Newsletter Editor":4,"YLP Volunteer":5,
    "Outside Speech":2,"Dual Member (per club)":3
  }
};

/* ---------- Data holders ---------- */
let summaryData=[], totalData=[], eaData=[], roleData=[], lmrData=[], spData=[], evData=[], lvlData=[], awdData=[], excomData=[], contestData=[], ttData=[];
let dtLeaderboard=null, dtDetails=null, chartCategory=null, chartProgress=null, chartClubRole=null, chartClubProgress=null;
let currentMember="";

/* ---------- Helpers ---------- */
const fetchCSV = (url)=>new Promise(res=>{
  Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:r=>res(r.data)});
});
const initials = name => (name||"").split(/\s+/).map(s=>s[0]).join("").slice(0,2).toUpperCase();
const val = (row,key)=>row?row[key]:undefined;
const dateKeysOf = row => Object.keys(row||{}).slice(2);

function safeDate(dStr){
  if(!dStr) return null;
  const n = new Date(dStr); if(!isNaN(n)) return n;
  const m = dStr.match(/^(\d{1,2})-([A-Za-z]{3})-(\d{2})$/);
  if(m){ const mons={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
    return new Date(2000+(+m[3]), mons[m[2].toLowerCase()], +m[1]);
  }
  return null;
}

function scoreRoleName(r){
  if(!r) return 0;
  const exact = POINT_RULES.roles[r]; if(exact!=null) return exact;
  const t=r.toLowerCase();
  if(t.includes("mc")) return 3;
  if(t.includes("general evaluator")||t==="ge") return 2;
  if(t.includes("ttm")||t.includes("table topics master")) return 2;
  if(t.includes("timer")) return 1;
  if(t.includes("ah")) return 1;
  if(t.includes("grammar")) return 1;
  if(t.includes("listener")) return 1;
  if(t.includes("evaluator")) return 2;
  return 0;
}
function scoreAwardText(txt){
  if(!txt) return 0; const t=txt.toLowerCase();
  if(t.includes("best speaker")) return POINT_RULES.awards["Best Speaker"];
  if(t.includes("best evaluator")) return POINT_RULES.awards["Best Evaluator"];
  if(t.includes("best tt")||t.includes("best table topics")) return POINT_RULES.awards["Best Table Topics"];
  if(t.includes("best role taker")) return POINT_RULES.awards["Best Role Taker"];
  return 0;
}
function scoreLevelText(txt){
  if(!txt) return 0; const t=txt.trim();
  if(POINT_RULES.levels[t]!=null) return POINT_RULES.levels[t];
  const m=t.match(/level\s*([1-5])/i); if(m) return POINT_RULES.levels[`Level ${m[1]}`]||0;
  if(/dtm/i.test(t)) return POINT_RULES.levels["DTM"]; return 0;
}

/* Contest/external helpers kept from your original */
function contestModifiers(base, cell){
  let pts=base; const x=(cell||"").toLowerCase();
  if(x.includes("area")) pts+=1;
  if(x.includes("division")) pts+=2;
  if(x.includes("district")) pts+=3;
  if(x.includes("dtac podium")) pts+=1;
  if(x.includes("arabic")) pts*=0.5;
  return pts;
}
function scoreContestTextUniq(txt){
  if(!txt) return 0;
  const t=txt.toLowerCase();
  let pts=0;
  if(t.includes("1st")) pts=Math.max(pts, contestModifiers(POINT_RULES.placement["1st"], txt));
  if(t.includes("2nd")) pts=Math.max(pts, contestModifiers(POINT_RULES.placement["2nd"], txt));
  if(t.includes("3rd")) pts=Math.max(pts, contestModifiers(POINT_RULES.placement["3rd"], txt));
  if(t.includes("chair")) pts=Math.max(pts, contestModifiers(POINT_RULES.contestBase["Contest Chair"], txt));
  if(t.includes("role")&&t.includes("taker")) pts=Math.max(pts, contestModifiers(POINT_RULES.contestBase["Contest Role Taker"], txt));
  ["International","Humorous","Evaluation","Table Topics"].forEach(sec=>{
    if(t.includes(sec.toLowerCase())) pts += contestModifiers(POINT_RULES.contestBase[sec], txt);
  });
  return pts;
}
function scoreExternalText(txt){
  if(!txt) return 0; const t=txt.toLowerCase();
  for(const [k,v] of Object.entries(POINT_RULES.external)){
    if(t.includes(k.toLowerCase())) return v;
  }
  if(t.includes("outside speech")) return POINT_RULES.external["Outside Speech"];
  if(t.includes("ylp")) return POINT_RULES.external["YLP Volunteer"];
  if(t.includes("newsletter")) return POINT_RULES.external["Newsletter Editor"];
  if(t.includes("dual member")) return POINT_RULES.external["Dual Member (per club)"];
  return 0;
}

/* ---------- Init ---------- */
(async function init(){
  try{
    [summaryData,totalData,eaData,roleData,lmrData,spData,evData,lvlData,awdData,excomData,contestData,ttData] =
      await Promise.all(Object.values(SHEETS).map(fetchCSV));

    buildLeaderboard();          // works from Summary
    buildMemberDropdown();       // names from Summary (alphabetical)
    buildGlobalRoleFilter();     // roles from RoleTaking + LastMinuteRoles + Speaker/Evaluator
    // set initial club charts
    refreshClubCharts();

  }catch(err){
    console.error("Init error:", err);
    alert("Failed to load data. Please check your network or Google Sheets permissions.");
  }
})();

/* ---------- Leaderboard ---------- */
function buildLeaderboard(){
  if(dtLeaderboard) dtLeaderboard.destroy();
  dtLeaderboard = $("#leaderboard").DataTable({
    data: summaryData.filter(r=>r.Name && r.Points),
    columns: [
      {title:"Name", data:"Name"},
      {title:"Points", data:"Points", render:d=>parseInt(d||0)}
    ],
    order:[[1,"desc"]],
    pageLength:25
  });
  // Rebind safely
  $('#leaderboard tbody').off('click').on('click','tr',function(){
    const row = dtLeaderboard.row(this).data();
    if(row?.Name){
      document.getElementById("memberSelect").value = row.Name;
      openProfile(row.Name);
    }
  });
}

/* ---------- Member dropdown (alphabetical) ---------- */
function buildMemberDropdown(){
  const sel = document.getElementById("memberSelect");
  const names = [...new Set(summaryData.map(r=>r.Name).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  sel.innerHTML = '<option value="">Select a member…</option>';
  names.forEach(n=>{ const o=document.createElement("option"); o.value=n; o.textContent=n; sel.appendChild(o); });
  sel.addEventListener("change", e=>{ if(e.target.value) openProfile(e.target.value); });
}

/* ---------- Global Role filter ---------- */
function buildGlobalRoleFilter(){
  const allRoles = new Set();
  [roleData,lmrData].forEach(sheet=>{
    sheet.forEach(r=>{
      Object.values(r).slice(2).forEach(v=>{ if(v && String(v).trim()) allRoles.add(String(v).trim()); });
    });
  });
  allRoles.add("Speaker"); allRoles.add("Evaluator");
  const list = [...allRoles].sort((a,b)=>a.localeCompare(b));

  const sel = document.getElementById("roleFilter");
  sel.innerHTML = '<option value="">All roles</option>';
  list.forEach(r=>{ const o=document.createElement("option"); o.value=r; o.textContent=r; sel.appendChild(o); });

  // Filter listeners (affect profile + club)
  sel.addEventListener("change", ()=>{ recomputeAndRender(); refreshClubCharts(); });
  document.getElementById("startDate").addEventListener("change", ()=>{ recomputeAndRender(); refreshClubCharts(); });
  document.getElementById("endDate").addEventListener("change", ()=>{ recomputeAndRender(); refreshClubCharts(); });
}

/* ---------- Profile ---------- */
function openProfile(member){
  currentMember = member;
  document.getElementById("profileName").textContent = member;
  document.getElementById("avatar").textContent = initials(member);

  const tRow = totalData.find(r=>r.Name===member);
  const totalPointsAll = tRow ? parseInt(tRow.Points||0) : 0;
  document.getElementById("profileSub").textContent = `Official Total Points: ${totalPointsAll}`;
  document.getElementById("totalPointsAll").textContent = totalPointsAll;

  // Clear dates (keep user’s choices? comment next two lines if you prefer to keep)
  // document.getElementById("startDate").value="";
  // document.getElementById("endDate").value="";

  recomputeAndRender();
}

function recomputeAndRender(){
  if(!currentMember) return;

  const roleFilter = document.getElementById("roleFilter").value;
  const sd = document.getElementById("startDate").value;
  const ed = document.getElementById("endDate").value;
  const startDate = sd ? new Date(sd) : null;
  const endDate   = ed ? new Date(ed) : null;

  const eaRow = eaData.find(r=>r.Name===currentMember)||{};
  const rtRow = roleData.find(r=>r.Name===currentMember)||{};
  const lmrRow= lmrData.find(r=>r.Name===currentMember)||{};
  const spRow = spData.find(r=>r.Name===currentMember)||{};
  const evRow = evData.find(r=>r.Name===currentMember)||{};
  const lvlRow= lvlData.find(r=>r.Name===currentMember)||{};
  const awdRow= awdData.find(r=>r.Name===currentMember)||{};
  const exRow = excomData.find(r=>r.Name===currentMember)||{};
  const ctRow = contestData.find(r=>r.Name===currentMember)||{};
  const ttRow = ttData.find(r=>r.Name===currentMember)||{};

  const dateKeys = dateKeysOf(eaRow);
  const within = d=>{ const dt=safeDate(d); if(!dt) return true; if(startDate && dt<startDate) return false; if(endDate && dt>endDate) return false; return true; };

  let meetingsCounted=0, filteredPoints=0; const distinctRoles=new Set();
  const categoryPts = {"Early Attendance":0,"Role Taking":0,"Last Minute Roles":0,"Speeches":0,"Evaluations":0,"Level Completions":0,"Awards":0,"ExCom & Sub.":0,"Contests":0,"External/Other/TT":0};

  const detailRows=[];

  for(const d of dateKeys){
    const att = val(eaRow,d);
    const attended = !!(att && att!=="A" && att!=="E");
    if(!attended) continue;
    if(!within(d)) continue;

    const role = val(rtRow,d)||"";
    const lmr  = val(lmrRow,d)||"";
    const sp   = val(spRow,d)||"";
    const ev   = val(evRow,d)||"";
    const lvl  = val(lvlRow,d)||"";
    const awd  = val(awdRow,d)||"";

    // role filter matching for this date
    const rolesThisDate=[];
    if(role) rolesThisDate.push(role);
    if(lmr) rolesThisDate.push(lmr);
    if(sp) rolesThisDate.push("Speaker");
    if(ev==="TRUE") rolesThisDate.push("Evaluator");
    if(roleFilter && !rolesThisDate.map(x=>String(x)).includes(roleFilter)) continue;

    meetingsCounted++;

    // Early attendance
    const eaPts = POINT_RULES.earlyAttendance(att); filteredPoints+=eaPts; categoryPts["Early Attendance"]+=eaPts;

    // Roles
    const rPts = scoreRoleName(role); filteredPoints+=rPts; categoryPts["Role Taking"]+=rPts; if(role) distinctRoles.add(role);
    const lPts = scoreRoleName(lmr);  filteredPoints+=lPts; categoryPts["Last Minute Roles"]+=lPts; if(lmr) distinctRoles.add(lmr);

    // Speech / Evaluation
    if(sp){ filteredPoints+=POINT_RULES.speech; categoryPts["Speeches"]+=POINT_RULES.speech; distinctRoles.add("Speaker"); }
    if(ev==="TRUE"){ filteredPoints+=POINT_RULES.evaluationTrue; categoryPts["Evaluations"]+=POINT_RULES.evaluationTrue; distinctRoles.add("Evaluator"); }

    // Awards & Levels (per date)
    const aPts=scoreAwardText(awd); filteredPoints+=aPts; categoryPts["Awards"]+=aPts;
    const lvPts=scoreLevelText(lvl); filteredPoints+=lvPts; categoryPts["Level Completions"]+=lvPts;

    // details
    detailRows.push({ Date:d, Attendance:att||"", Roles:role||"", Speech: sp ? "Yes":"", Evaluation: ev==="TRUE" ? "Yes":"" });
  }

  // Once-per-year/event categories (dedup, within date range)
  function uniqNonEmptyVals(row){
    const set=new Set();
    Object.keys(row||{}).slice(2).forEach(k=>{
      if(!within(k)) return;
      const v=row[k]; if(v) set.add(String(v).trim());
    });
    return [...set];
  }
  const exUniq = uniqNonEmptyVals(exRow);
  let exPtsTotal=0; exUniq.forEach(txt=>{
    const t=txt.toLowerCase();
    for(const [k,v] of Object.entries(POINT_RULES.excom)){ if(t.includes(k.toLowerCase())) { exPtsTotal+=v; break; } }
  });
  filteredPoints += exPtsTotal; categoryPts["ExCom & Sub."] += exPtsTotal;

  const ctUniq = uniqNonEmptyVals(ctRow);
  let ctPts=0; ctUniq.forEach(txt=>{ ctPts += scoreContestTextUniq(txt); });
  filteredPoints += ctPts; categoryPts["Contests"] += ctPts;

  const ttUniq = uniqNonEmptyVals(ttRow);
  let ttPts=0; ttUniq.forEach(txt=>{ ttPts += scoreExternalText(txt); });
  filteredPoints += ttPts; categoryPts["External/Other/TT"] += ttPts;

  // KPIs
  document.getElementById("meetingsCount").textContent = meetingsCounted;
  document.getElementById("filteredPoints").textContent = Math.round(filteredPoints);
  document.getElementById("distinctRoles").textContent = distinctRoles.size;

  // charts
  drawCategoryChart(categoryPts);
  drawProgressChart(detailRows);

  // details table
  if(dtDetails) dtDetails.destroy();
  dtDetails = $("#detailTable").DataTable({
    data:detailRows,
    columns:[
      {title:"Date", data:"Date"},
      {title:"Attendance", data:"Attendance"},
      {title:"Roles", data:"Roles"},
      {title:"Speech", data:"Speech"},
      {title:"Evaluation", data:"Evaluation"}
    ],
    order:[[0,"asc"]],
    pageLength:25,
    searching:false
  });
}

/* ---------- Charts (member) ---------- */
function drawCategoryChart(tally){
  const labels=Object.keys(tally); const values=labels.map(k=>tally[k]);
  if(chartCategory) chartCategory.destroy();
  chartCategory = new Chart(document.getElementById("categoryChart").getContext("2d"),{
    type:"bar",
    data:{labels,datasets:[{label:"Weighted Points (Filtered)",data:values}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}
  });
}
function drawProgressChart(detailRows){
  const byDate={};
  for(const r of detailRows){
    let pts=0;
    pts+=POINT_RULES.earlyAttendance(r.Attendance);
    pts+=scoreRoleName(r.Roles);
    if(r.Speech==="Yes") pts+=POINT_RULES.speech;
    if(r.Evaluation==="Yes") pts+=POINT_RULES.evaluationTrue;
    byDate[r.Date]=(byDate[r.Date]||0)+pts;
  }
  const dates=Object.keys(byDate).sort((a,b)=>{const da=safeDate(a),db=safeDate(b); return (da&&db)?da-db:a.localeCompare(b);});
  let cum=0; const series=dates.map(d=>cum+=byDate[d]);
  if(chartProgress) chartProgress.destroy();
  chartProgress = new Chart(document.getElementById("progressChart").getContext("2d"),{
    type:"line",
    data:{labels:dates,datasets:[{label:"Cumulative Weighted Points (Filtered)",data:series,fill:false,tension:.25}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}
  });
}

/* ---------- Club-wide charts (respect filters) ---------- */
function refreshClubCharts(){
  const roleFilter = document.getElementById("roleFilter").value;
  const sd = document.getElementById("startDate").value;
  const ed = document.getElementById("endDate").value;
  const startDate = sd ? new Date(sd) : null;
  const endDate   = ed ? new Date(ed) : null;
  const within = d=>{ const dt=safeDate(d); if(!dt) return true; if(startDate && dt<startDate) return false; if(endDate && dt>endDate) return false; return true; };

  // All relevant date keys across EA
  const allDatesSet=new Set();
  eaData.forEach(r=>dateKeysOf(r).forEach(k=>{ if(within(k)) allDatesSet.add(k); }));
  const dates=[...allDatesSet].sort((a,b)=>{const da=safeDate(a),db=safeDate(b); return (da&&db)?da-db:a.localeCompare(b);});

  // Index by name for quick lookup
  function indexByName(sheet){ const m=new Map(); sheet.forEach(r=>m.set(r.Name,r)); return m; }
  const idxEA=indexByName(eaData), idxRT=indexByName(roleData), idxLMR=indexByName(lmrData), idxSP=indexByName(spData), idxEV=indexByName(evData);

  // ---- Club cumulative progress (meeting-level only) ----
  const perDateSum={}; // date -> total points (respecting role filter)
  eaData.forEach(memberRow=>{
    const name=memberRow.Name; if(!name) return;
    dates.forEach(d=>{
      const att = val(idxEA.get(name),d);
      const attended = !!(att && att!=="A" && att!=="E");
      if(!attended) return;

      const role = val(idxRT.get(name)||{},d)||"";
      const lmr  = val(idxLMR.get(name)||{},d)||"";
      const sp   = val(idxSP.get(name)||{},d)||"";
      const ev   = val(idxEV.get(name)||{},d)||"";

      let pts=0;
      if(!roleFilter){
        // all meeting-level categories
        pts += POINT_RULES.earlyAttendance(att);
        pts += scoreRoleName(role);
        pts += scoreRoleName(lmr);
        if(sp) pts += POINT_RULES.speech;
        if(ev==="TRUE") pts += POINT_RULES.evaluationTrue;
      }else{
        // only selected role category
        if(roleFilter==="Speaker" && sp) pts += POINT_RULES.speech;
        else if(roleFilter==="Evaluator" && ev==="TRUE") pts += POINT_RULES.evaluationTrue;
        else{
          if(role===roleFilter) pts += scoreRoleName(role);
          if(lmr===roleFilter)  pts += scoreRoleName(lmr);
          // Note: we intentionally exclude early attendance when a specific role is selected
        }
      }
      if(pts>0) perDateSum[d]=(perDateSum[d]||0)+pts;
    });
  });

  let cum=0; const series=dates.map(d=>cum+= (perDateSum[d]||0));
  if(chartClubProgress) chartClubProgress.destroy();
  chartClubProgress = new Chart(document.getElementById("clubProgressChart").getContext("2d"),{
    type:"line",
    data:{labels:dates,datasets:[{label: roleFilter? `Club Cumulative (${roleFilter})` : "Club Cumulative (All Meeting-level)", data:series, fill:false, tension:.25}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}
  });

  // ---- Club points by role (bar) ----
  const roleAgg = {}; // role -> points (within date range)
  // Aggregate from role taking + last minute roles
  [roleData,lmrData].forEach(sheet=>{
    sheet.forEach(r=>{
      const name = r.Name; if(!name) return;
      dateKeysOf(r).forEach(d=>{
        if(!within(d)) return;
        const valRole = r[d]; if(!valRole) return;
        const pts = scoreRoleName(valRole);
        if(pts>0){
          if(!roleFilter || roleFilter===valRole){
            roleAgg[valRole]=(roleAgg[valRole]||0)+pts;
          }
        }
      });
    });
  });
  // Speakers & Evaluators
  spData.forEach(r=>{
    dateKeysOf(r).forEach(d=>{
      if(!within(d)) return;
      if(r[d]){
        if(!roleFilter || roleFilter==="Speaker"){
          roleAgg["Speaker"]=(roleAgg["Speaker"]||0)+POINT_RULES.speech;
        }
      }
    });
  });
  evData.forEach(r=>{
    dateKeysOf(r).forEach(d=>{
      if(!within(d)) return;
      if(r[d]==="TRUE"){
        if(!roleFilter || roleFilter==="Evaluator"){
          roleAgg["Evaluator"]=(roleAgg["Evaluator"]||0)+POINT_RULES.evaluationTrue;
        }
      }
    });
  });

  const rLabels = Object.keys(roleAgg).sort((a,b)=>a.localeCompare(b));
  const rValues = rLabels.map(k=>roleAgg[k]);
  if(chartClubRole) chartClubRole.destroy();
  chartClubRole = new Chart(document.getElementById("clubRoleChart").getContext("2d"),{
    type:"bar",
    data:{labels:rLabels,datasets:[{label: roleFilter? `Points (${roleFilter})` : "Club Points by Role", data:rValues}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}
  });

  // Club total note (sum of official totals from Summary)
  const clubTotalAll = summaryData.reduce((a,r)=>a+(parseInt(r.Points||0)||0),0);
  document.getElementById("clubTotalsNote").textContent =
    roleFilter ? `Club charts filtered by role "${roleFilter}" and date range.` :
                 `Note: Club cumulative uses meeting-level categories. Official club total (all categories): ${clubTotalAll}.`;
}

/* ---------- Tabs ---------- */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(tab=>tab.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});
</script>
</body>
</html>
