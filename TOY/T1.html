<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Toastmasters Dashboard</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0; padding: 0;
    }
    header {
      background: #004165;
      color: #fff;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header img {
      height: 40px;
    }
    .container {
      padding: 20px;
    }
    select {
      padding: 8px;
      font-size: 16px;
      margin-bottom: 20px;
    }
    .tabs {
      margin-bottom: 15px;
    }
    .tab-btn {
      background: #d71a28;
      border: none;
      color: white;
      padding: 8px 15px;
      margin-right: 5px;
      cursor: pointer;
      border-radius: 5px;
    }
    .tab-btn.active-tab {
      background: #004165;
    }
    .chart-container {
      background: #fff;
      padding: 15px;
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #meetingSummaries > div {
      margin-bottom: 12px;
      padding: 10px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
<header>
  <div>
    <img src="https://www.toastmasters.org/-/media/toastmasters/brand-portal/files/logos/official-logo/primary-logo/primary-logo-color.ashx" alt="Toastmasters Logo"/>
    <img src="club-logo.png" alt="Club Logo"/> <!-- Replace with your club logo -->
  </div>
  <h2>Toastmasters Club Dashboard</h2>
</header>

<div class="container">
  <label for="memberSelect"><strong>Select Member:</strong></label>
  <select id="memberSelect"></select>

  <div class="tabs">
    <button class="tab-btn" data-sheet="Total">Total</button>
    <button class="tab-btn" data-sheet="Role Taking">Roles</button>
    <button class="tab-btn" data-sheet="Speeches">Speeches</button>
    <button class="tab-btn" data-sheet="Evaluations">Evaluations</button>
    <button class="tab-btn" data-sheet="Level Completions">Level Completions</button>
    <button class="tab-btn" data-sheet="Awards">Awards</button>
    <button class="tab-btn" data-sheet="External">External</button>
    <button class="tab-btn" data-sheet="Other">Other</button>
    <button class="tab-btn" data-sheet="Last Minute Roles">Last Minute Roles</button>
  </div>

  <table id="detailTable" class="display" style="width:100%"></table>

  <div class="chart-container">
    <h3>Progress Over Time</h3>
    <canvas id="progressChart"></canvas>
  </div>

  <div class="chart-container">
    <h3>Role Breakdown</h3>
    <canvas id="roleBreakdownChart"></canvas>
  </div>

  <div class="chart-container">
    <h3>Meeting Summaries</h3>
    <div id="meetingSummaries"></div>
  </div>
</div>

<script>
const SHEET_ID = "19x7OzxLlfG5YarEgksoX-drLaf12Ci98JpYkBvQpoMI";

// Generic fetcher (returns array of objects)
async function fetchSheet(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tq=select *`;
  const response = await fetch(url);
  const text = await response.text();
  const json = JSON.parse(text.substr(47).slice(0, -2));
  const cols = json.table.cols.map(c => c.label || "");
  const rows = json.table.rows.map(r => {
    const obj = {};
    r.c.forEach((cell, i) => obj[cols[i] || `col${i}`] = cell ? cell.v : "");
    return obj;
  });
  return rows;
}

// Populate member dropdown
async function loadMembers() {
  const totalData = await fetchSheet("Total");
  const members = totalData.map(r => r.Name).filter(Boolean);
  const memberSelect = document.getElementById("memberSelect");
  memberSelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join("");
}

// Load detail table
async function loadDetail(sheetName, member) {
  const data = await fetchSheet(sheetName);
  const filtered = data.filter(r => r.Name === member);

  if ($.fn.DataTable.isDataTable("#detailTable")) {
    $("#detailTable").DataTable().destroy();
    $("#detailTable").empty();
  }

  if (filtered.length) {
    $("#detailTable").DataTable({
      data: filtered,
      columns: Object.keys(filtered[0]).map(c => ({ title: c, data: c })),
      pageLength: 10
    });
  }
}

// Progress chart (line from Total)
async function loadProgress(member) {
  const totalData = await fetchSheet("Total");
  const row = totalData.find(r => r.Name === member);
  if (!row) return;

  const labels = Object.keys(row).filter(k => k !== "Name");
  const values = labels.map(l => parseInt(row[l] || 0));

  const ctx = document.getElementById("progressChart").getContext("2d");
  if (window.progressChart) window.progressChart.destroy();
  window.progressChart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets: [{ label: "Points", data: values, fill: false, borderColor: "#004165" }] }
  });
}

// Role breakdown pie chart
async function loadRoleBreakdown(member) {
  const roleData = await fetchSheet("Role Taking");
  const row = roleData.find(r => r.Name === member);
  if (!row) return;

  const roleCounts = {};
  Object.keys(row).forEach(key => {
    if (key === "Name" || key === "Points") return;
    const value = row[key];
    if (value && value.trim() !== "") {
      roleCounts[value] = (roleCounts[value] || 0) + 1;
    }
  });

  const ctx = document.getElementById("roleBreakdownChart").getContext("2d");
  if (window.roleChart) window.roleChart.destroy();
  window.roleChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: Object.keys(roleCounts),
      datasets: [{ data: Object.values(roleCounts), backgroundColor: ["#004165","#d71a28","#f2df74","#007A5E","#7A003C","#ff9933","#3399ff","#9933ff","#66cc99","#ffcc00"] }]
    },
    options: { plugins: { legend: { position: "bottom" } } }
  });
}

// Meeting summaries
async function loadMeetingSummaries(member) {
  const tabs = ["Role Taking","Speeches","Evaluations","Level Completions","Awards","External","Other","Last Minute Roles"];
  const container = document.getElementById("meetingSummaries");
  container.innerHTML = "";
  const meetingData = {};

  for (const tab of tabs) {
    const data = await fetchSheet(tab);
    const row = data.find(r => r.Name === member);
    if (!row) continue;

    Object.keys(row).forEach(key => {
      if (key === "Name" || key === "Points") return;
      const value = row[key];
      if (value && value.trim() !== "") {
        if (!meetingData[key]) meetingData[key] = [];
        meetingData[key].push(`${tab}: ${value}`);
      }
    });
  }

  Object.keys(meetingData).forEach(meeting => {
    const div = document.createElement("div");
    div.innerHTML = `<strong>${meeting}</strong><ul>` + meetingData[meeting].map(item => `<li>${item}</li>`).join("") + `</ul>`;
    container.appendChild(div);
  });

  if (!Object.keys(meetingData).length) container.innerHTML = "<p>No meeting activity found.</p>";
}

// Initialization
document.addEventListener("DOMContentLoaded", async () => {
  await loadMembers();
  const memberSelect = document.getElementById("memberSelect");
  const initialMember = memberSelect.value;

  // Default tab = Total
  const defaultBtn = document.querySelector(".tab-btn[data-sheet='Total']");
  defaultBtn.classList.add("active-tab");
  await loadDetail("Total", initialMember);
  await loadProgress(initialMember);
  await loadRoleBreakdown(initialMember);
  await loadMeetingSummaries(initialMember);

  // Member change
  memberSelect.addEventListener("change", async e => {
    const member = e.target.value;
    const activeSheet = document.querySelector(".tab-btn.active-tab").dataset.sheet;
    await loadDetail(activeSheet, member);
    await loadProgress(member);
    await loadRoleBreakdown(member);
    await loadMeetingSummaries(member);
  });

  // Tab switching
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active-tab"));
      btn.classList.add("active-tab");
      const member = memberSelect.value;
      await loadDetail(btn.dataset.sheet, member);
      await loadMeetingSummaries(member);
    });
  });
});
</script>
</body>
</html>
