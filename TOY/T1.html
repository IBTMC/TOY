<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Toastmasters Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 20px; }
    header { display: flex; align-items: center; justify-content: space-between; }
    header img { height: 60px; }
    .tabs { margin: 20px 0; }
    .tab-btn { padding: 10px 15px; margin-right: 5px; cursor: pointer; border-radius: 8px; }
    .active-tab { background: #004165; color: white; }
    .inactive-tab { background: #ddd; color: black; }
    #charts { display: flex; flex-wrap: wrap; gap: 20px; }
    canvas { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <header>
    <img src="toastmasters-logo.png" alt="Toastmasters Logo">
    <h1>Toastmasters Club Dashboard</h1>
    <img src="club-logo.png" alt="Club Logo">
  </header>

  <label for="memberSelect">Select Member:</label>
  <select id="memberSelect"></select>

  <div class="tabs">
    <button class="tab-btn inactive-tab" data-sheet="Role Taking">Roles</button>
    <button class="tab-btn inactive-tab" data-sheet="Speeches">Speeches</button>
    <button class="tab-btn inactive-tab" data-sheet="Evaluations">Evaluations</button>
    <button class="tab-btn inactive-tab" data-sheet="Level Completions">Level Completions</button>
    <button class="tab-btn inactive-tab" data-sheet="Awards">Awards</button>
    <button class="tab-btn inactive-tab" data-sheet="External">External</button>
    <button class="tab-btn inactive-tab" data-sheet="Other">Other</button>
    <button class="tab-btn inactive-tab" data-sheet="Last Minute Roles">Last Minute Roles</button>
  </div>

  <h2>Points Breakdown</h2>
  <table id="detailTable" class="display" style="width:100%"></table>

  <h2>Charts</h2>
  <div id="charts">
    <canvas id="progressChart" width="400" height="200"></canvas>
    <canvas id="roleBreakdownChart" width="400" height="200"></canvas>
  </div>

  <h2>Meeting Summaries</h2>
  <div id="meetingSummaries"></div>

<script>
const SHEET_ID = "19x7OzxLlfG5YarEgksoX-drLaf12Ci98JpYkBvQpoMI";

// Fetch sheet
async function fetchSheet(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}&cachebuster=${new Date().getTime()}`;
  const response = await fetch(url);
  const text = await response.text();

  if (sheetName === "Summary" || sheetName === "Total") {
    return Papa.parse(text, { header: true }).data.filter(r => r.Name);
  }

  const parsed = Papa.parse(text, { header: false }).data;
  if (!parsed.length) return [];

  const headers = parsed[0];
  const subHeaders = parsed[1];
  const finalHeaders = headers.map((h, i) => {
    if (subHeaders[i]) return `${h} ${subHeaders[i]}`.trim();
    return h;
  });

  const dataRows = parsed.slice(2);
  return dataRows.map(row => {
    const obj = {};
    finalHeaders.forEach((h, i) => {
      obj[h] = row[i];
    });
    return obj;
  });
}

// Populate members
async function loadSummary() {
  const summaryData = await fetchSheet("Summary");
  const members = summaryData.map(r => r.Name).filter(Boolean);
  const memberSelect = document.getElementById("memberSelect");
  memberSelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join("");
}

// Load details
async function loadDetail(sheetName, member) {
  const data = await fetchSheet(sheetName);
  const filtered = data.filter(r => r.Name === member);

  if ($.fn.DataTable.isDataTable("#detailTable")) {
    $("#detailTable").DataTable().destroy();
    $("#detailTable").empty();
  }

  if (filtered.length) {
    $("#detailTable").DataTable({
      data: filtered,
      columns: Object.keys(filtered[0]).map(c => ({ title: c, data: c })),
      pageLength: 10
    });
  }
}

// Example charts
async function loadExtendedProgress(member) {
  const totalData = await fetchSheet("Total");
  const row = totalData.find(r => r.Name === member);
  if (!row) return;

  const labels = Object.keys(row).filter(k => k !== "Name");
  const values = labels.map(l => parseInt(row[l] || 0));

  const ctx = document.getElementById("progressChart").getContext("2d");
  new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{ label: "Points Over Time", data: values, fill: false, borderColor: "#004165" }]
    }
  });
}

document.addEventListener("DOMContentLoaded", async () => {
  await loadSummary();
  const memberSelect = document.getElementById("memberSelect");
  const initialMember = memberSelect.value;

  // Default active tab = Roles
  const defaultBtn = document.querySelector(".tab-btn[data-sheet='Role Taking']");
  defaultBtn.classList.add("active-tab");
  defaultBtn.classList.remove("inactive-tab");

  await loadDetail("Role Taking", initialMember);
  await loadExtendedProgress(initialMember);

  // Member change
  memberSelect.addEventListener("change", async e => {
    const member = e.target.value;
    const activeSheet = document.querySelector(".tab-btn.active-tab").dataset.sheet;
    await loadDetail(activeSheet, member);
    await loadExtendedProgress(member);
  });

  // Tab switching
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      document.querySelectorAll(".tab-btn").forEach(b => {
        b.classList.remove("active-tab");
        b.classList.add("inactive-tab");
      });
      btn.classList.add("active-tab");
      btn.classList.remove("inactive-tab");

      const member = memberSelect.value;
      await loadDetail(btn.dataset.sheet, member);
    });
  });
});
</script>
</body>
</html>
