<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Toastmasters Club Dashboard</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { color: #004165; text-align: center; }
    .controls { margin: 20px 0; text-align: center; }
    select { padding: 5px; }
    .tabs { text-align: center; margin-bottom: 20px; }
    .tab-btn {
      padding: 10px 15px; margin: 3px; border: none;
      border-radius: 5px; cursor: pointer;
    }
    .active-tab { background: #004165; color: #fff; }
    .inactive-tab { background: #ccc; color: #333; }
    #charts { display: flex; justify-content: space-around; flex-wrap: wrap; }
    #charts canvas { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 10px; }
    #meetingSummaries { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>Toastmasters Club Dashboard</h1>

  <div class="controls">
    <label for="memberSelect"><strong>Select Member:</strong></label>
    <select id="memberSelect"></select>
  </div>

  <div class="tabs">
    <button class="tab-btn inactive-tab" data-sheet="Total">Total</button>
    <button class="tab-btn inactive-tab" data-sheet="Role Taking">Roles</button>
    <button class="tab-btn inactive-tab" data-sheet="Speeches">Speeches</button>
    <button class="tab-btn inactive-tab" data-sheet="Evaluations">Evaluations</button>
    <button class="tab-btn inactive-tab" data-sheet="Level Completions">Level Completions</button>
    <button class="tab-btn inactive-tab" data-sheet="Awards">Awards</button>
    <button class="tab-btn inactive-tab" data-sheet="External">External</button>
    <button class="tab-btn inactive-tab" data-sheet="Other">Other</button>
    <button class="tab-btn inactive-tab" data-sheet="Last Minute Roles">Last Minute Roles</button>
  </div>

  <table id="detailTable" class="display" style="width:100%"></table>

  <div id="charts">
    <canvas id="progressChart" width="400" height="250"></canvas>
    <canvas id="roleBreakdownChart" width="400" height="250"></canvas>
  </div>

  <h2>Meeting Summaries</h2>
  <div id="meetingSummaries"></div>

<script>
const SHEET_ID = "19x7OzxLlfG5YarEgksoX-drLaf12Ci98JpYkBvQpoMI";

// Fetch sheet
async function fetchSheet(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}&cachebuster=${new Date().getTime()}`;
  const response = await fetch(url);
  const text = await response.text();

  if (sheetName === "Summary" || sheetName === "Total") {
    return Papa.parse(text, { header: true }).data.filter(r => r.Name);
  }

  const parsed = Papa.parse(text, { header: false }).data;
  if (!parsed.length) return [];

  const headers = parsed[0];
  const subHeaders = parsed[1];
  const finalHeaders = headers.map((h, i) => {
    if (subHeaders[i]) return `${h} ${subHeaders[i]}`.trim();
    return h;
  });

  const dataRows = parsed.slice(2);
  return dataRows.map(row => {
    const obj = {};
    finalHeaders.forEach((h, i) => {
      obj[h] = row[i];
    });
    return obj;
  });
}

// Populate members (from Summary)
async function loadSummary() {
  const summaryData = await fetchSheet("Summary");
  const members = summaryData.map(r => r.Name).filter(Boolean);
  const memberSelect = document.getElementById("memberSelect");
  memberSelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join("");
}

// Load details
async function loadDetail(sheetName, member) {
  const data = await fetchSheet(sheetName);
  const filtered = data.filter(r => r.Name === member);

  if ($.fn.DataTable.isDataTable("#detailTable")) {
    $("#detailTable").DataTable().destroy();
    $("#detailTable").empty();
  }

  if (filtered.length) {
    $("#detailTable").DataTable({
      data: filtered,
      columns: Object.keys(filtered[0]).map(c => ({ title: c, data: c })),
      pageLength: 10
    });
  }
}

// Line chart for points (from Total)
async function loadExtendedProgress(member) {
  const totalData = await fetchSheet("Total");
  const row = totalData.find(r => r.Name === member);
  if (!row) return;

  const labels = Object.keys(row).filter(k => k !== "Name");
  const values = labels.map(l => parseInt(row[l] || 0));

  const ctx = document.getElementById("progressChart").getContext("2d");
  if (window.progressChart) window.progressChart.destroy();
  window.progressChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{ label: "Points", data: values, fill: false, borderColor: "#004165" }]
    }
  });
}

// Pie chart for role breakdown
async function loadRoleBreakdown(member) {
  const roleData = await fetchSheet("Role Taking");
  const row = roleData.find(r => r.Name === member);
  if (!row) return;

  const roleCounts = {};
  Object.keys(row).forEach(key => {
    if (key.startsWith("Name") || key.startsWith("Points")) return;
    const value = row[key];
    if (value && value.trim() !== "") {
      roleCounts[value] = (roleCounts[value] || 0) + 1;
    }
  });

  const ctx = document.getElementById("roleBreakdownChart").getContext("2d");
  if (window.roleChart) window.roleChart.destroy();
  window.roleChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: Object.keys(roleCounts),
      datasets: [{
        data: Object.values(roleCounts),
        backgroundColor: [
          "#004165", "#d71a28", "#f2df74", "#007A5E", "#7A003C",
          "#ff9933", "#3399ff", "#9933ff", "#66cc99", "#ffcc00"
        ]
      }]
    },
    options: {
      plugins: { legend: { position: "bottom" } }
    }
  });
}

// Meeting Summaries
async function loadMeetingSummaries(member) {
  const tabs = ["Role Taking", "Speeches", "Evaluations", "Level Completions", "Awards", "External", "Other", "Last Minute Roles"];
  const container = document.getElementById("meetingSummaries");
  container.innerHTML = "";

  const meetingData = {};

  for (const tab of tabs) {
    const data = await fetchSheet(tab);
    const row = data.find(r => r.Name === member);
    if (!row) continue;

    Object.keys(row).forEach(key => {
      if (key.startsWith("Name") || key.startsWith("Points")) return;
      const value = row[key];
      if (value && value.trim() !== "") {
        if (!meetingData[key]) meetingData[key] = [];
        meetingData[key].push(`${tab}: ${value}`);
      }
    });
  }

  Object.keys(meetingData).forEach(meeting => {
    const div = document.createElement("div");
    div.style.marginBottom = "15px";
    div.style.padding = "10px";
    div.style.background = "#fff";
    div.style.borderRadius = "8px";
    div.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";

    div.innerHTML = `<strong>${meeting}</strong><ul>` +
      meetingData[meeting].map(item => `<li>${item}</li>`).join("") +
      `</ul>`;
    container.appendChild(div);
  });

  if (!Object.keys(meetingData).length) {
    container.innerHTML = "<p>No meeting activity found for this member.</p>";
  }
}

// Init
document.addEventListener("DOMContentLoaded", async () => {
  await loadSummary();
  const memberSelect = document.getElementById("memberSelect");
  const initialMember = memberSelect.value;

  // Default active tab = Total
  const defaultBtn = document.querySelector(".tab-btn[data-sheet='Total']");
  defaultBtn.classList.add("active-tab");
  defaultBtn.classList.remove("inactive-tab");

  await loadDetail("Total", initialMember);
  await loadExtendedProgress(initialMember);
  await loadRoleBreakdown(initialMember);
  await loadMeetingSummaries(initialMember);

  // Member change
  memberSelect.addEventListener("change", async e => {
    const member = e.target.value;
    const activeSheet = document.querySelector(".tab-btn.active-tab").dataset.sheet;
    await loadDetail(activeSheet, member);
    await loadExtendedProgress(member);
    await loadRoleBreakdown(member);
    await loadMeetingSummaries(member);
  });

  // Tab switching
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      document.querySelectorAll(".tab-btn").forEach(b => {
        b.classList.remove("active-tab");
        b.classList.add("inactive-tab");
      });
      btn.classList.add("active-tab");
      btn.classList.remove("inactive-tab");

      const member = memberSelect.value;
      await loadDetail(btn.dataset.sheet, member);
      await loadMeetingSummaries(member);
    });
  });
});
</script>
</body>
</html>
