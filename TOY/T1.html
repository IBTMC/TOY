<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Toastmasters Club Portal</title>

<!-- jQuery + DataTables + Chart.js -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --tm-navy:#004165;
    --tm-red:#d71a28;
    --tm-gold:#f2df74;
    --bg:#f6f7fb;
    --card:#ffffff;
    --text:#1d2430;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{
    background:var(--tm-navy); color:#fff; padding:14px 18px;
    display:flex; align-items:center; gap:14px; justify-content:space-between
  }
  header .brand{display:flex;align-items:center;gap:12px}
  header img{height:44px; background:#fff; border-radius:8px; padding:6px}
  header h1{font-size:20px; margin:0; font-weight:700}
  .container{max-width:1220px; margin:24px auto; padding:0 16px}

  .filters, .kpis, .charts, .cards, .tabs {margin-top:18px}
  .panel{
    background:var(--card); border-radius:14px; padding:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.06)
  }

  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .kpi{display:flex;flex-direction:column;gap:6px}
  .kpi .label{font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.06em}
  .kpi .value{font-size:28px;font-weight:800;color:var(--tm-navy)}

  .filters .row{display:flex;flex-wrap:wrap;gap:10px}
  .filters .row > div{flex:1 1 220px}
  label{display:block;font-size:12px;color:#6b7280;margin-bottom:6px}
  select,input[type="date"]{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}

  .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .charts .panel{min-height:360px}
  canvas{width:100%;height:280px}

  .cards{display:grid;grid-template-columns:1fr;gap:12px}
  .leaderboard table{width:100%}

  .tabs{display:flex;flex-wrap:wrap;gap:8px}
  .tab-btn{
    border:none;padding:10px 14px;border-radius:10px;cursor:pointer;
    background:var(--tm-red);color:#fff;font-weight:600
  }
  .tab-btn.active{background:var(--tm-navy)}
  .hidden{display:none !important}

  .error{background:#fff3f3;color:#8a1f1f;border:1px solid #f0c2c2;border-radius:10px;padding:10px;margin-top:12px}
  footer{margin:32px 0;color:#6b7280;text-align:center;font-size:12px}
  @media (max-width:980px){ .charts{grid-template-columns:1fr} .kpis{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="https://www.toastmasters.org/-/media/toastmasters/brand-portal/files/logos/official-logo/primary-logo/primary-logo-color.ashx" alt="Toastmasters International">
    <h1>Toastmasters Club Portal</h1>
  </div>
  <img src="club-logo.png" alt="Club Logo"> <!-- replace with your file or URL -->
</header>

<div class="container">

  <!-- Filters -->
  <div class="filters panel">
    <div class="row">
      <div>
        <label for="memberSelect">Select member</label>
        <select id="memberSelect"></select>
      </div>
      <div>
        <label for="roleFilter">Filter by role (optional)</label>
        <select id="roleFilter">
          <option value="__ALL__">All roles</option>
        </select>
      </div>
      <div>
        <label for="startDate">Start date</label>
        <input id="startDate" type="date" />
      </div>
      <div>
        <label for="endDate">End date</label>
        <input id="endDate" type="date" />
      </div>
    </div>
    <div id="errorBox" class="error hidden"></div>
  </div>

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi panel">
      <div class="label">Meetings Counted</div>
      <div id="kpiMeetings" class="value">—</div>
    </div>
    <div class="kpi panel">
      <div class="label">Total Points</div>
      <div id="kpiPoints" class="value">—</div>
    </div>
    <div class="kpi panel">
      <div class="label">Distinct Roles</div>
      <div id="kpiRoles" class="value">—</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts">
    <div class="panel">
      <h3>Category Breakdown</h3>
      <canvas id="categoryChart"></canvas>
    </div>
    <div class="panel">
      <h3>Role Breakdown</h3>
      <canvas id="roleChart"></canvas>
    </div>
    <div class="panel">
      <h3>Cumulative Progress</h3>
      <canvas id="cumulativeChart"></canvas>
    </div>
    <div class="panel leaderboard">
      <h3>Leaderboard (Club)</h3>
      <table id="leaderboardTable" class="display"></table>
    </div>
  </div>

  <!-- Per-Meeting Details -->
  <div class="cards">
    <div class="panel">
      <h3>Per-Meeting Details</h3>
      <div id="meetingSummaries"></div>
    </div>
  </div>

  <!-- Raw tabs -->
  <div class="panel" style="margin-top:12px">
    <div class="tabs">
      <button class="tab-btn active" data-sheet="Total">Total</button>
      <button class="tab-btn" data-sheet="Role Taking">Roles</button>
      <button class="tab-btn" data-sheet="Speeches">Speeches</button>
      <button class="tab-btn" data-sheet="Evaluations">Evaluations</button>
      <button class="tab-btn" data-sheet="Level Completions">Level Completions</button>
      <button class="tab-btn" data-sheet="Awards">Awards</button>
      <button class="tab-btn" data-sheet="External">External</button>
      <button class="tab-btn" data-sheet="Other">Other</button>
      <button class="tab-btn" data-sheet="Last Minute Roles">Last Minute Roles</button>
    </div>
    <table id="detailTable" class="display" style="width:100%"></table>
  </div>

  <footer>Live from Google Sheets • Toastmasters branding compliant</footer>
</div>

<script>
const SHEET_ID = "19x7OzxLlfG5YarEgksoX-drLaf12Ci98JpYkBvQpoMI";
const DETAIL_TABS = ["Role Taking","Speeches","Evaluations","Level Completions","Awards","External","Other","Last Minute Roles"];
const CATEGORY_KEYS = ["Early Attendance","Role Taking","Speeches","Evaluations","Level Completions","Awards","ExCom & Sub.","Contests","External","Other","Last Minute Roles"];

let cache = {}; // per-sheet cache

// ---------------- GViz fetch ----------------
async function fetchGViz(sheetName){
  if(cache[sheetName]) return cache[sheetName];
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tq=select%20*`;
  const res = await fetch(url);
  const txt = await res.text();

  // Extract JSON
  const m = txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);/);
  if(!m){ showError(`Failed to parse GViz for "${sheetName}".`); return []; }
  const json = JSON.parse(m[1]);

  const cols = (json.table.cols || []).map((c,i)=> c.label || `col${i}`);
  const rows = (json.table.rows || []).map(r=>{
    const o={};
    (r.c||[]).forEach((cell,i)=>{
      o[cols[i]] = cell ? (cell.f ?? cell.v ?? "") : "";
    });
    return o;
  });

  cache[sheetName] = rows;
  return rows;
}

function showError(msg){
  const box = document.getElementById('errorBox');
  box.textContent = msg;
  box.classList.remove('hidden');
}
function clearError(){
  document.getElementById('errorBox').classList.add('hidden');
}

// ---------------- helpers ----------------
function parseHeaderDate(label){
  const d1 = new Date(label);
  if(!isNaN(d1)) return d1;
  const m = String(label).trim().match(/^(\d{1,2})[-\/\s]([A-Za-z]{3})[-\/\s](\d{2,4})$/);
  if(m){
    const [_,dd,mon,yy] = m;
    const months={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
    const year=(+yy<100)?2000+(+yy):+yy;
    return new Date(year, months[mon], +dd);
  }
  return null;
}
function inRange(date, start, end){
  if(!date) return false;
  if(start && date < start) return false;
  if(end && date > end) return false;
  return true;
}
function toLabel(d){ return d.toISOString().slice(0,10); }

function cleanedRows(rows){
  // Drop row 2 (meeting number row) whose Name is empty
  return rows.filter(r => r.Name && String(r.Name).trim() !== "");
}

function dateColumnsFrom(sheetRows){
  const sample = sheetRows[0] || {};
  return Object.keys(sample).filter(k => k!=="Name" && k!=="Points" && parseHeaderDate(k));
}

// ---------------- populate UI ----------------
async function populateMembers(){
  const total = await fetchGViz("Total");
  const members = total.map(r=>r.Name).filter(Boolean);
  const sel = document.getElementById('memberSelect');
  sel.innerHTML = members.map(m=>`<option value="${m}">${m}</option>`).join('');
}

async function populateRoleFilter(){
  const set = new Set();
  // Roles from Role Taking (cell values, rows >= 3)
  const roleRows = cleanedRows(await fetchGViz("Role Taking"));
  roleRows.forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      if(v && String(v).trim()) set.add(String(v).trim());
    });
  });

  // "Speaker" if any non-empty in Speeches
  const speechRows = cleanedRows(await fetchGViz("Speeches"));
  let hasSpeaker=false;
  speechRows.forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      if(v && String(v).trim()) hasSpeaker=true;
    });
  });
  if(hasSpeaker) set.add("Speaker");

  // "Evaluator" if any TRUE in Evaluations
  const evalRows = cleanedRows(await fetchGViz("Evaluations"));
  let hasEvaluator=false;
  evalRows.forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const val = (typeof v === 'string') ? v.trim().toUpperCase() : v;
      if(val===true || val==="TRUE") hasEvaluator=true;
    });
  });
  if(hasEvaluator) set.add("Evaluator");

  const sel = document.getElementById('roleFilter');
  sel.innerHTML = `<option value="__ALL__">All roles</option>` + [...set].sort().map(r=>`<option>${r}</option>`).join('');
}

// ---------------- KPIs ----------------
async function updateKPIs(member, start, end, roleFilter){
  // meetings counted = distinct date columns in Role Taking that fall within range
  const roleRows = await fetchGViz("Role Taking");
  const headers = dateColumnsFrom(roleRows);
  const meetings = headers.map(parseHeaderDate).filter(Boolean).filter(d=>inRange(d,start,end)).length;
  document.getElementById('kpiMeetings').textContent = meetings || 0;

  // total points from Total
  const total = await fetchGViz("Total");
  const row = total.find(r=>r.Name===member);
  const points = row && row.Points ? Number(row.Points) : 0;
  document.getElementById('kpiPoints').textContent = points;

  // distinct roles for member, within filters
  const memberRoleRow = cleanedRows(await fetchGViz("Role Taking")).find(r=>r.Name===member) || {};
  const distinct = new Set();

  Object.entries(memberRoleRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d = parseHeaderDate(k);
    if(!d) return;
    if(!inRange(d,start,end)) return;
    const val = String(v||"").trim();
    if(!val) return;
    if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker" && roleFilter!=="Evaluator" && val!==roleFilter) return;
    distinct.add(val);
  });

  // include Speaker/Evaluator if filtering or present in range
  if(roleFilter==="Speaker" || roleFilter==="__ALL__"){
    const speeches = cleanedRows(await fetchGViz("Speeches")).find(r=>r.Name===member) || {};
    let spoke=false;
    Object.entries(speeches).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const d=parseHeaderDate(k); if(!d) return;
      if(!inRange(d,start,end)) return;
      if(v && String(v).trim()) spoke=true;
    });
    if(spoke) distinct.add("Speaker");
  }
  if(roleFilter==="Evaluator" || roleFilter==="__ALL__"){
    const evals = cleanedRows(await fetchGViz("Evaluations")).find(r=>r.Name===member) || {};
    let evaled=false;
    Object.entries(evals).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const d=parseHeaderDate(k); if(!d) return;
      if(!inRange(d,start,end)) return;
      const val=(typeof v==='string')?v.trim().toUpperCase():v;
      if(val===true || val==="TRUE") evaled=true;
    });
    if(evaled) distinct.add("Evaluator");
  }

  document.getElementById('kpiRoles').textContent = distinct.size;
}

// ---------------- Leaderboard ----------------
async function buildLeaderboard(){
  const total = await fetchGViz("Total");
  const data = total.filter(r=>r.Name).map(r=>({Name:r.Name, Points:Number(r.Points||0)}));
  data.sort((a,b)=>b.Points-a.Points);

  if ($.fn.DataTable.isDataTable("#leaderboardTable")) {
    $("#leaderboardTable").DataTable().clear().rows.add(data).draw();
  } else {
    $("#leaderboardTable").DataTable({
      data,
      columns:[{title:"Member",data:"Name"},{title:"Points",data:"Points"}],
      paging:false, searching:false, info:false, order:[[1,"desc"]]
    });
  }
}

// ---------------- Raw table tab ----------------
async function loadDetailTable(sheetName, member){
  const rows = cleanedRows(await fetchGViz(sheetName));
  const filtered = member ? rows.filter(r=>r.Name===member) : rows;

  if ($.fn.DataTable.isDataTable("#detailTable")) {
    $("#detailTable").DataTable().destroy();
    $("#detailTable").empty();
  }
  if (!filtered.length){ return; }
  $("#detailTable").DataTable({
    data: filtered,
    columns: Object.keys(filtered[0]).map(c=>({title:c,data:c})),
    pageLength: 10
  });
}

// ---------------- Charts ----------------
const CATEGORY_KEYS = ["Early Attendance","Role Taking","Speeches","Evaluations","Level Completions","Awards","ExCom & Sub.","Contests","External","Other","Last Minute Roles"];
let categoryChart, roleChart, cumulativeChart;

function pickCategories(totalRow){
  const items=[];
  CATEGORY_KEYS.forEach(k=>{
    if(k in totalRow){
      items.push({label:k, value:Number(totalRow[k]||0)});
    }
  });
  return items;
}

async function drawCategoryChart(member){
  const total = await fetchGViz("Total");
  const row = total.find(r=>r.Name===member) || {};
  const items = pickCategories(row);
  const ctx = document.getElementById('categoryChart').getContext('2d');
  if (categoryChart) categoryChart.destroy();
  categoryChart = new Chart(ctx, {
    type:"bar",
    data:{ labels: items.map(i=>i.label), datasets:[{label:"Points", data: items.map(i=>i.value)}] },
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

// Role Breakdown Pie — respects date & role filters
async function drawRoleChart(member, start, end, roleFilter){
  const counts={};

  // Role Taking specific roles
  const roleRow = cleanedRows(await fetchGViz("Role Taking")).find(r=>r.Name===member) || {};
  Object.entries(roleRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    const val=String(v||"").trim(); if(!val) return;
    if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker" && roleFilter!=="Evaluator" && val!==roleFilter) return;
    counts[val]=(counts[val]||0)+1;
  });

  // Speaker
  const speechRow = cleanedRows(await fetchGViz("Speeches")).find(r=>r.Name===member) || {};
  let speakerCount=0;
  Object.entries(speechRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    if(v && String(v).trim()) speakerCount++;
  });
  if(speakerCount && (!roleFilter || roleFilter==="__ALL__" || roleFilter==="Speaker")) {
    counts["Speaker"]=(counts["Speaker"]||0)+speakerCount;
  }

  // Evaluator
  const evalRow = cleanedRows(await fetchGViz("Evaluations")).find(r=>r.Name===member) || {};
  let evaluatorCount=0;
  Object.entries(evalRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    const val=(typeof v==='string')?v.trim().toUpperCase():v;
    if(val===true || val==="TRUE") evaluatorCount++;
  });
  if(evaluatorCount && (!roleFilter || roleFilter==="__ALL__" || roleFilter==="Evaluator")) {
    counts["Evaluator"]=(counts["Evaluator"]||0)+evaluatorCount;
  }

  const ctx = document.getElementById('roleChart').getContext('2d');
  if (roleChart) roleChart.destroy();
  roleChart = new Chart(ctx, {
    type:"pie",
    data:{ labels:Object.keys(counts), datasets:[{ data:Object.values(counts) }] },
    options:{ responsive:true, plugins:{ legend:{position:"bottom"} } }
  });
}

// Cumulative Progress — activity units over time
async function drawCumulative(member, start, end, roleFilter){
  const buckets={}; // dateLabel -> count

  // Role Taking (specific roles)
  const roleRow = cleanedRows(await fetchGViz("Role Taking")).find(r=>r.Name===member) || {};
  Object.entries(roleRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    const val=String(v||"").trim(); if(!val) return;
    if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker" && roleFilter!=="Evaluator" && val!==roleFilter) return;
    const lab=toLabel(d); buckets[lab]=(buckets[lab]||0)+1;
  });

  // Speaker
  const speechRow = cleanedRows(await fetchGViz("Speeches")).find(r=>r.Name===member) || {};
  Object.entries(speechRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    if(!(v && String(v).trim())) return;
    if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker") return;
    const lab=toLabel(d); buckets[lab]=(buckets[lab]||0)+1;
  });

  // Evaluator
  const evalRow = cleanedRows(await fetchGViz("Evaluations")).find(r=>r.Name===member) || {};
  Object.entries(evalRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    const val=(typeof v==='string')?v.trim().toUpperCase():v;
    const isTrue=(val===true || val==="TRUE");
    if(!isTrue) return;
    if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Evaluator") return;
    const lab=toLabel(d); buckets[lab]=(buckets[lab]||0)+1;
  });

  // (Optional) count non-empty cells in other tabs when no specific role filter
  if(!roleFilter || roleFilter==="__ALL__"){
    for(const tab of ["Level Completions","Awards","External","Other","Last Minute Roles"]){
      const row = cleanedRows(await fetchGViz(tab)).find(r=>r.Name===member) || {};
      Object.entries(row).forEach(([k,v])=>{
        if(k==="Name"||k==="Points") return;
        const d=parseHeaderDate(k); if(!d) return;
        if(!inRange(d,start,end)) return;
        if(!(v && String(v).trim())) return;
        const lab=toLabel(d); buckets[lab]=(buckets[lab]||0)+1;
      });
    }
  }

  const labels = Object.keys(buckets).sort();
  let cum=0;
  const values = labels.map(d=> (cum += buckets[d]));
  const ctx = document.getElementById('cumulativeChart').getContext('2d');
  if (cumulativeChart) cumulativeChart.destroy();
  cumulativeChart = new Chart(ctx, {
    type:"line",
    data:{ labels, datasets:[{label:"Cumulative Activities", data:values, fill:false}] },
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

// ---------------- Per-Meeting Details ----------------
async function renderMeetingDetails(member, start, end, roleFilter){
  const container = document.getElementById('meetingSummaries');
  container.innerHTML = "";
  const byMeeting = {};

  // helper to push an item
  function push(date, label){
    const lab = toLabel(date);
    if(!byMeeting[lab]) byMeeting[lab]=[];
    byMeeting[lab].push(label);
  }

  // Roles
  const roleRow = cleanedRows(await fetchGViz("Role Taking")).find(r=>r.Name===member) || {};
  Object.entries(roleRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    const val=String(v||"").trim(); if(!val) return;
    if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker" && roleFilter!=="Evaluator" && val!==roleFilter) return;
    push(d, `Role: ${val}`);
  });

  // Speeches
  const speechRow = cleanedRows(await fetchGViz("Speeches")).find(r=>r.Name===member) || {};
  Object.entries(speechRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    const val=String(v||"").trim(); if(!val) return;
    if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker") return;
    push(d, `Speaker: ${val}`);
  });

  // Evaluations
  const evalRow = cleanedRows(await fetchGViz("Evaluations")).find(r=>r.Name===member) || {};
  Object.entries(evalRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    const val=(typeof v==='string')?v.trim().toUpperCase():v;
    const isTrue=(val===true || val==="TRUE");
    if(!isTrue) return;
    if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Evaluator") return;
    push(d, `Evaluator: ✓`);
  });

  // Other tabs when no specific role selected
  if(!roleFilter || roleFilter==="__ALL__"){
    for(const tab of ["Level Completions","Awards","External","Other","Last Minute Roles"]){
      const row = cleanedRows(await fetchGViz(tab)).find(r=>r.Name===member) || {};
      Object.entries(row).forEach(([k,v])=>{
        if(k==="Name"||k==="Points") return;
        const d=parseHeaderDate(k); if(!d) return;
        if(!inRange(d,start,end)) return;
        const val=String(v||"").trim(); if(!val) return;
        push(d, `${tab}: ${val}`);
      });
    }
  }

  const days = Object.keys(byMeeting).sort();
  if(!days.length){ container.innerHTML = "<p>No meeting activity for current filters.</p>"; return; }
  days.forEach(day=>{
    const div = document.createElement('div');
    div.className="meeting panel";
    div.style.marginBottom="10px";
    div.innerHTML = `<strong>${day}</strong><ul>${byMeeting[day].map(x=>`<li>${x}</li>`).join("")}</ul>`;
    container.appendChild(div);
  });
}

// ---------------- Recompute ----------------
async function recomputeAll(){
  clearError();
  const member = document.getElementById('memberSelect').value;
  const roleFilter = document.getElementById('roleFilter').value;
  const start = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null;
  const end   = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null;

  await updateKPIs(member, start, end, roleFilter);
  await drawCategoryChart(member);
  await drawRoleChart(member, start, end, roleFilter);
  await drawCumulative(member, start, end, roleFilter);
  await renderMeetingDetails(member, start, end, roleFilter);

  // raw table for active tab
  const activeBtn = document.querySelector('.tab-btn.active');
  if (activeBtn){
    await loadDetailTable(activeBtn.dataset.sheet, member);
  }
}

// ---------------- Date defaults (min/max) ----------------
async function setDefaultDateRange(){
  const roleRows = await fetchGViz("Role Taking");
  const headers = dateColumnsFrom(roleRows);
  const dates = headers.map(parseHeaderDate).filter(Boolean).sort((a,b)=>a-b);
  if(!dates.length) return;
  const min=dates[0], max=dates[dates.length-1];
  const start = document.getElementById('startDate');
  const end = document.getElementById('endDate');
  start.value = toLabel(min);
  end.value = toLabel(max);
}

// ---------------- Init ----------------
document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    await populateMembers();
    await populateRoleFilter();
    await setDefaultDateRange();
    await buildLeaderboard();

    // Default: load Total tab table
    const member = document.getElementById('memberSelect').value;
    await loadDetailTable('Total', member);

    // First compute all
    await recomputeAll();

    // listeners
    document.getElementById('memberSelect').addEventListener('change', recomputeAll);
    document.getElementById('roleFilter').addEventListener('change', recomputeAll);
    document.getElementById('startDate').addEventListener('change', recomputeAll);
    document.getElementById('endDate').addEventListener('change', recomputeAll);

    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const member = document.getElementById('memberSelect').value;
        await loadDetailTable(btn.dataset.sheet, member);
      });
    });

  }catch(e){
    showError("Initialization error: "+ (e?.message || e));
    console.error(e);
  }
});
</script>
</body>
</html>
