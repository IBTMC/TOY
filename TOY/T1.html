<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toastmaster of the Year Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Header -->
  <header class="bg-[#004165] text-white p-4 flex justify-between items-center">
    <img src="toastmasters-logo.png" alt="Toastmasters Logo" class="h-12">
    <h1 class="text-2xl font-bold">Toastmaster of the Year Dashboard</h1>
    <img src="club-logo.png" alt="Club Logo" class="h-12">
  </header>

  <main class="p-4">
    <!-- Member Selector -->
    <div class="mb-4">
      <label for="memberSelect" class="block mb-2 font-semibold">Select Member:</label>
      <select id="memberSelect" class="p-2 border rounded w-full md:w-1/3"></select>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-bold">Total Points</h2>
        <p id="totalPoints" class="text-2xl text-[#772432]"></p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-bold">Meetings Counted</h2>
        <p id="meetingCount" class="text-2xl text-[#772432]"></p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-bold">Distinct Roles</h2>
        <p id="roleCount" class="text-2xl text-[#772432]"></p>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-bold mb-2">Category Breakdown</h2>
        <canvas id="categoryChart"></canvas>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-bold mb-2">Cumulative Progress</h2>
        <canvas id="progressChart"></canvas>
      </div>
    </div>

    <!-- Tabs for details -->
    <div class="mb-4">
      <div class="flex flex-wrap gap-2 mb-2">
        <button class="tab-btn px-4 py-2 bg-[#004165] text-white rounded" data-sheet="Role Taking">Roles</button>
        <button class="tab-btn px-4 py-2 bg-gray-300 rounded" data-sheet="Speeches">Speeches</button>
        <button class="tab-btn px-4 py-2 bg-gray-300 rounded" data-sheet="Evaluations">Evaluations</button>
        <button class="tab-btn px-4 py-2 bg-gray-300 rounded" data-sheet="Table Topics">Table Topics</button>
        <button class="tab-btn px-4 py-2 bg-gray-300 rounded" data-sheet="Early Attendance">Early Attendance</button>
        <button class="tab-btn px-4 py-2 bg-gray-300 rounded" data-sheet="Awards">Awards</button>
        <button class="tab-btn px-4 py-2 bg-gray-300 rounded" data-sheet="External">External</button>
        <button class="tab-btn px-4 py-2 bg-gray-300 rounded" data-sheet="Other">Other</button>
        <button class="tab-btn px-4 py-2 bg-gray-300 rounded" data-sheet="Last Minute Roles">Last Minute Roles</button>
      </div>
      <table id="detailTable" class="display w-full"></table>
    </div>

    <!-- Leaderboard -->
    <div class="bg-white p-4 rounded shadow">
      <h2 class="text-lg font-bold mb-2">Club Leaderboard</h2>
      <table id="leaderboard" class="display w-full"></table>
    </div>
  </main>

  <script>
    const SHEET_ID = "19x7OzxLlfG5YarEgksoX-drLaf12Ci98JpYkBvQpoMI";

    async function fetchSheet(sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}&cachebuster=${new Date().getTime()}`;
      const response = await fetch(url);
      const text = await response.text();
      return Papa.parse(text, { header: true }).data;
    }

    async function loadSummary() {
      const summaryData = await fetchSheet("Summary");
      const members = summaryData.map(r => r.Name).filter(Boolean);
      const memberSelect = document.getElementById("memberSelect");
      memberSelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join("");
    }

    async function loadDetail(sheetName, member) {
      const data = await fetchSheet(sheetName);
      const filtered = data.filter(r => r.Name === member);
      if ($.fn.DataTable.isDataTable("#detailTable")) {
        $("#detailTable").DataTable().destroy();
        $("#detailTable").empty();
      }
      $("#detailTable").DataTable({ data: filtered, columns: Object.keys(data[0] || {}).map(c => ({ title: c, data: c })) });
    }

    async function loadTotal(member) {
      const totals = await fetchSheet("Total");
      const row = totals.find(r => r.Name === member);
      if (row) {
        document.getElementById("totalPoints").textContent = row.Total || "0";
        document.getElementById("meetingCount").textContent = row.Meetings || "0";
        document.getElementById("roleCount").textContent = row.Roles || "0";
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadSummary();
      const memberSelect = document.getElementById("memberSelect");
      const initialMember = memberSelect.value;

      // Set default active tab (Roles)
      const defaultBtn = document.querySelector(".tab-btn[data-sheet='Role Taking']");
      defaultBtn.classList.add("bg-[#004165]", "text-white");
      defaultBtn.classList.remove("bg-gray-300");

      await loadTotal(initialMember);
      await loadDetail("Role Taking", initialMember);

      // Member change listener
      memberSelect.addEventListener("change", async e => {
        const member = e.target.value;
        await loadTotal(member);
        const activeSheet = document.querySelector(".tab-btn.bg-[#004165]").dataset.sheet;
        await loadDetail(activeSheet, member);
      });

      // Tab button click listeners
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          document.querySelectorAll(".tab-btn").forEach(b => {
            b.classList.remove("bg-[#004165]", "text-white");
            b.classList.add("bg-gray-300");
          });
          btn.classList.add("bg-[#004165]", "text-white");
          btn.classList.remove("bg-gray-300");

          const member = memberSelect.value;
          await loadDetail(btn.dataset.sheet, member);
        });
      });
    });
  </script>
</body>
</html>
