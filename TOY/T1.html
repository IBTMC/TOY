<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Toastmasters Club Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- jQuery + DataTables + Chart.js -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --tm-navy:#004165;
    --tm-red:#d71a28;
    --tm-gold:#f2df74;
    --bg:#f6f7fb;
    --card:#ffffff;
    --text:#1d2430;
    --muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{
    background:var(--tm-navy); color:#fff; padding:14px 18px;
    display:flex; align-items:center; gap:14px; justify-content:space-between
  }
  header .brand{display:flex;align-items:center;gap:12px}
  header img{height:44px; background:#fff; border-radius:8px; padding:6px}
  header h1{font-size:20px; margin:0; font-weight:700}
  .container{max-width:1240px; margin:24px auto; padding:0 16px}

  .topbar {display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between}
  .mode-toggle{display:flex; align-items:center; gap:8px; background:var(--card); padding:10px 12px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .mode-toggle button{border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700}
  .mode-toggle .active{background:var(--tm-red); color:#fff}

  .filters, .kpis, .charts, .cards, .tabs {margin-top:18px}
  .panel{
    background:var(--card); border-radius:14px; padding:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.06)
  }

  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .kpi{display:flex;flex-direction:column;gap:6px}
  .kpi .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
  .kpi .value{font-size:28px;font-weight:800;color:var(--tm-navy)}

  .filters .row{display:flex;flex-wrap:wrap;gap:10px}
  .filters .row > div{flex:1 1 220px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  select,input[type="date"]{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}

  .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .charts .panel{min-height:360px}
  canvas{width:100%;height:280px}

  .cards{display:grid;grid-template-columns:1fr;gap:12px}
  .leaderboard table{width:100%}

  .tabs{display:flex;flex-wrap:wrap;gap:8px}
  .tab-btn{
    border:none;padding:10px 14px;border-radius:10px;cursor:pointer;
    background:var(--tm-red);color:#fff;font-weight:600
  }
  .tab-btn.active{background:var(--tm-navy)}
  .hidden{display:none !important}

  .error{background:#fff3f3;color:#8a1f1f;border:1px solid #f0c2c2;border-radius:10px;padding:10px;margin-top:12px}
  footer{margin:32px 0;color:var(--muted);text-align:center;font-size:12px}
  @media (max-width:980px){ .charts{grid-template-columns:1fr} .kpis{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="https://www.toastmasters.org/-/media/toastmasters/brand-portal/files/logos/official-logo/primary-logo/primary-logo-color.ashx" alt="Toastmasters International">
    <h1>Toastmasters Club Dashboard</h1>
  </div>
  <!-- Replace with your club logo file or a URL -->
  <img src="club-logo.png" alt="Club Logo">
</header>

<div class="container">

  <div class="topbar">
    <div class="mode-toggle">
      <span style="font-weight:700;">Display:</span>
      <button id="modeAll" class="active">All Members</button>
      <button id="modeMember">Member Only</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters panel">
    <div class="row">
      <div>
        <label for="memberSelect">Select member</label>
        <select id="memberSelect"><option value="">— Select —</option></select>
      </div>
      <div>
        <label for="roleFilter">Filter by role (optional)</label>
        <select id="roleFilter"><option value="__ALL__">All roles</option></select>
      </div>
      <div>
        <label for="startDate">Start date</label>
        <input id="startDate" type="date" />
      </div>
      <div>
        <label for="endDate">End date</label>
        <input id="endDate" type="date" />
      </div>
    </div>
    <div id="errorBox" class="error hidden"></div>
  </div>

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi panel">
      <div class="label">Meetings Counted</div>
      <div id="kpiMeetings" class="value">—</div>
    </div>
    <div class="kpi panel">
      <div class="label">Total Points</div>
      <div id="kpiPoints" class="value">—</div>
    </div>
    <div class="kpi panel">
      <div class="label">Distinct Roles</div>
      <div id="kpiRoles" class="value">—</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts">
    <div class="panel">
      <h3>Category Breakdown</h3>
      <canvas id="categoryChart"></canvas>
    </div>
    <div class="panel">
      <h3>Role Breakdown</h3>
      <canvas id="roleChart"></canvas>
    </div>
    <div class="panel">
      <h3>Cumulative Progress</h3>
      <canvas id="cumulativeChart"></canvas>
    </div>
    <div class="panel leaderboard">
      <h3>Leaderboard (Club)</h3>
      <table id="leaderboardTable" class="display"></table>
    </div>
  </div>

  <!-- Per-Meeting Details -->
  <div class="cards">
    <div class="panel">
      <h3>Per-Meeting Details</h3>
      <div id="meetingSummaries"></div>
    </div>
  </div>

  <!-- Raw tabs -->
  <div class="panel" style="margin-top:12px">
    <div class="tabs">
      <button class="tab-btn active" data-sheet="Total">Total</button>
      <button class="tab-btn" data-sheet="Role Taking">Roles</button>
      <button class="tab-btn" data-sheet="Speeches">Speeches</button>
      <button class="tab-btn" data-sheet="Evaluations">Evaluations</button>
      <button class="tab-btn" data-sheet="Level Completions">Level Completions</button>
      <button class="tab-btn" data-sheet="Awards">Awards</button>
      <button class="tab-btn" data-sheet="ExCom & Sub.">ExCom & Sub.</button>
      <button class="tab-btn" data-sheet="Early Attendance">Early Attendance</button>
      <button class="tab-btn" data-sheet="Other">Other</button>
      <button class="tab-btn" data-sheet="Last Minute Roles">Last Minute Roles</button>
    </div>
    <table id="detailTable" class="display" style="width:100%"></table>
  </div>

  <footer>Live from Google Sheets • Toastmasters branding compliant</footer>
</div>

<script>
/** ==== CONFIG ==== **/
const SHEET_ID = "19x7OzxLlfG5YarEgksoX-drLaf12Ci98JpYkBvQpoMI";
const CATEGORY_KEYS = ["Early Attendance","Role Taking","Speeches","Evaluations","Level Completions","Awards","ExCom & Sub.","Contests","External","Other","Last Minute Roles"];
const DETAIL_TABS = ["Role Taking","Speeches","Evaluations","Level Completions","Awards","ExCom & Sub.","Early Attendance","Other","Last Minute Roles"];

let cache = {};         // sheetName -> rows
let cacheHeaders = {};  // sheetName -> labels
let currentMode = "ALL"; // "ALL" or "MEMBER"

/** ===== GViz fetch (published sheet) ===== **/
async function fetchGViz(sheetName){
  if(cache[sheetName]) return cache[sheetName];
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&tq=select%20*`;
  const res = await fetch(url);
  const txt = await res.text();
  const m = txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);/);
  if(!m){ showError(`Failed to parse GViz for "${sheetName}".`); return []; }
  const json = JSON.parse(m[1]);

  const cols = (json.table.cols || []).map((c,i)=> c.label || `col${i}`);
  cacheHeaders[sheetName] = cols.slice();

  const rows = (json.table.rows || []).map(r=>{
    const o={};
    (r.c||[]).forEach((cell,i)=>{
      const label = cols[i];
      const val = cell ? (cell.f ?? cell.v ?? "") : "";
      o[label] = val;
      // Special internal alias ONLY for "ExCom & Sub."
      if(label === "ExCom & Sub.") o["ExCom_And_Sub"] = val;
    });
    if(o["ExCom_And_Sub"] === undefined) o["ExCom_And_Sub"] = o["ExCom & Sub."] ?? "";
    return o;
  });

  cache[sheetName] = rows;
  return rows;
}

/** ===== helpers ===== **/
function showError(msg){ const box = document.getElementById('errorBox'); box.textContent = msg; box.classList.remove('hidden'); }
function clearError(){ document.getElementById('errorBox').classList.add('hidden'); }
function toISO(d){ return d.toISOString().slice(0,10); }

function parseHeaderDate(label){
  if(!label) return null;
  const d1 = new Date(label);
  if(!isNaN(d1)) return d1;
  const m = String(label).trim().match(/^(\d{1,2})[-\/\s]([A-Za-z]{3})[-\/\s](\d{2,4})$/);
  if(m){
    const [_,dd,mon,yy] = m;
    const months={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10};
    const year=(+yy<100)?2000+(+yy):+yy;
    return new Date(year, months[mon], +dd);
  }
  return null;
}
function inRange(date, start, end){
  if(!date) return false;
  if(start && date < start) return false;
  if(end && date > end) return false;
  return true;
}
function cleanedRows(rows){
  // Drops the "Meeting #" second header row (blank Name)
  return (rows||[]).filter(r => r.Name && String(r.Name).trim() !== "");
}
function dateColumnsFrom(rows){
  const sample = rows[0] || {};
  return Object.keys(sample).filter(k => k!=="Name" && k!=="Points" && parseHeaderDate(k));
}

/** ===== UI population ===== **/
async function populateMembers(){
  const total = await fetchGViz("Total");
  const members = Array.from(new Set(total.map(r=>String(r.Name||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  const sel = document.getElementById('memberSelect');
  sel.innerHTML = `<option value="">— Select —</option>` + members.map(m=>`<option value="${m}">${m}</option>`).join('');
}

async function populateRoleFilter(){
  const roleSet = new Set();

  // Roles from Role Taking (skip header row by requiring Name present)
  const rtRows = cleanedRows(await fetchGViz("Role Taking"));
  rtRows.forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      if(!parseHeaderDate(k)) return; // only date columns
      const val = String(v||"").trim();
      if(val) roleSet.add(val);
    });
  });

  // "Speaker" if any non-empty in Speeches
  const spRows = cleanedRows(await fetchGViz("Speeches"));
  let hasSpeaker = false;
  spRows.forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      if(!parseHeaderDate(k)) return;
      if(String(v||"").trim()) hasSpeaker = true;
    });
  });
  if(hasSpeaker) roleSet.add("Speaker");

  // "Evaluator" if any TRUE in Evaluations
  const evRows = cleanedRows(await fetchGViz("Evaluations"));
  let hasEvaluator=false;
  evRows.forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      if(!parseHeaderDate(k)) return;
      const val=(typeof v==='string')?v.trim().toUpperCase():v;
      if(val===true || val==="TRUE") hasEvaluator=true;
    });
  });
  if(hasEvaluator) roleSet.add("Evaluator");

  const sel = document.getElementById('roleFilter');
  sel.innerHTML = `<option value="__ALL__">All roles</option>` + [...roleSet].sort().map(r=>`<option value="${r}">${r}</option>`).join('');
}

/** ===== KPIs ===== **/
async function updateKPIs(member, start, end, roleFilter){
  // Meetings Counted from Role Taking date columns within range
  const rt = await fetchGViz("Role Taking");
  const headers = dateColumnsFrom(rt).map(parseHeaderDate).filter(Boolean);
  const meetings = headers.filter(d=>inRange(d,start,end)).length;
  document.getElementById('kpiMeetings').textContent = meetings || 0;

  // Total Points from Total
  const total = await fetchGViz("Total");
  let points = 0;
  if(member){
    const row = total.find(r=>r.Name===member);
    points = row && row.Points ? Number(row.Points) : 0;
  }else{
    points = total.reduce((s,r)=> s + Number(r.Points||0), 0);
  }
  document.getElementById('kpiPoints').textContent = points;

  // Distinct Roles across filters for selected scope
  const distinct = new Set();

  const rtRows = cleanedRows(await fetchGViz("Role Taking"));
  (member ? rtRows.filter(r=>r.Name===member) : rtRows).forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const d = parseHeaderDate(k); if(!d) return;
      if(!inRange(d,start,end)) return;
      const val = String(v||"").trim(); if(!val) return;
      if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker" && roleFilter!=="Evaluator" && val!==roleFilter) return;
      distinct.add(val);
    });
  });

  const spRows = cleanedRows(await fetchGViz("Speeches"));
  (member ? spRows.filter(r=>r.Name===member) : spRows).forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const d=parseHeaderDate(k); if(!d) return;
      if(!inRange(d,start,end)) return;
      if(!(v && String(v).trim())) return;
      if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker") return;
      distinct.add("Speaker");
    });
  });

  const evRows = cleanedRows(await fetchGViz("Evaluations"));
  (member ? evRows.filter(r=>r.Name===member) : evRows).forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const d=parseHeaderDate(k); if(!d) return;
      if(!inRange(d,start,end)) return;
      const val=(typeof v==='string')?v.trim().toUpperCase():v;
      if(!(val===true || val==="TRUE")) return;
      if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Evaluator") return;
      distinct.add("Evaluator");
    });
  });

  document.getElementById('kpiRoles').textContent = distinct.size;
}

/** ===== Leaderboard (Summary preferred) ===== **/
async function buildLeaderboard(){
  let rows = await fetchGViz("Summary");
  if(!rows || !rows.length) rows = await fetchGViz("Total");
  const data = rows
    .filter(r=>r.Name)
    .map(r=>({ Name:r.Name, Points:Number(r.Points||0) }))
    .sort((a,b)=>b.Points-a.Points);

  if ($.fn.DataTable.isDataTable("#leaderboardTable")) {
    $("#leaderboardTable").DataTable().clear().rows.add(data).draw();
  } else {
    $("#leaderboardTable").DataTable({
      data,
      columns:[{title:"Member",data:"Name"},{title:"Points",data:"Points"}],
      paging:false, searching:false, info:false, order:[[1,"desc"]]
    });
  }
}

/** ===== Raw table tab ===== **/
function buildColumnsForSheet(sheetName, rows){
  if(!rows.length) return [];
  const labels = Object.keys(rows[0]);
  return labels.map(lbl=>{
    if(sheetName==="Total" && lbl==="ExCom & Sub."){
      return { title:"ExCom & Sub.", data:"ExCom_And_Sub" }; // internal alias
    }
    return { title: lbl, data: lbl };
  });
}

async function loadDetailTable(sheetName, member){
  const raw = await fetchGViz(sheetName);
  const rows = (sheetName === "Total") ? raw : cleanedRows(raw);
  const filtered = member ? rows.filter(r=>r.Name===member) : rows;

  if ($.fn.DataTable.isDataTable("#detailTable")) {
    $("#detailTable").DataTable().destroy();
    $("#detailTable").empty();
  }
  if (!filtered.length){
    $("#detailTable").DataTable({ data: [], columns: [{title:"No data", data:null}], searching:false, paging:false, info:false });
    return;
  }

  if(sheetName==="Total"){
    filtered.forEach(r=>{
      if(r["ExCom_And_Sub"] === undefined) r["ExCom_And_Sub"] = r["ExCom & Sub."] ?? "";
    });
  }

  const cols = buildColumnsForSheet(sheetName, filtered);
  $("#detailTable").DataTable({
    data: filtered,
    columns: cols,
    pageLength: 10
  });
}

/** ===== Charts ===== **/
let categoryChart, roleChart, cumulativeChart;
function resetChart(chart){ if(chart){ chart.destroy(); } }

// Category Breakdown: selected member row in Total, else aggregate
async function drawCategoryChart(member){
  const total = await fetchGViz("Total");
  let items;
  if(member){
    const r = total.find(x=>x.Name===member) || {};
    items = CATEGORY_KEYS.filter(k=>k in r).map(k=>({label:k, value:Number(r[k]||0)}));
  }else{
    const sums = {}; CATEGORY_KEYS.forEach(k=>sums[k]=0);
    total.forEach(r=>{ CATEGORY_KEYS.forEach(k=>{ if(k in r) sums[k]+=Number(r[k]||0); }); });
    items = CATEGORY_KEYS.map(k=>({label:k, value:sums[k]}));
  }

  const ctx = document.getElementById('categoryChart').getContext('2d');
  resetChart(categoryChart);
  categoryChart = new Chart(ctx, {
    type:"bar",
    data:{ labels: items.map(i=>i.label), datasets:[{label:"Points", data: items.map(i=>i.value)}] },
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

// Role Breakdown Pie: Roles + Speaker + Evaluator
async function drawRoleChart(member, start, end, roleFilter){
  const counts={};
  const add = r => counts[r]=(counts[r]||0)+1;

  const rtRows = cleanedRows(await fetchGViz("Role Taking"));
  (member ? rtRows.filter(r=>r.Name===member) : rtRows).forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const d=parseHeaderDate(k); if(!d) return;
      if(!inRange(d,start,end)) return;
      const val=String(v||"").trim(); if(!val) return;
      if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker" && roleFilter!=="Evaluator" && val!==roleFilter) return;
      add(val);
    });
  });

  const spRows = cleanedRows(await fetchGViz("Speeches"));
  (member ? spRows.filter(r=>r.Name===member) : spRows).forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const d=parseHeaderDate(k); if(!d) return;
      if(!inRange(d,start,end)) return;
      if(!(v && String(v).trim())) return;
      if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker") return;
      add("Speaker");
    });
  });

  const evRows = cleanedRows(await fetchGViz("Evaluations"));
  (member ? evRows.filter(r=>r.Name===member) : evRows).forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const d=parseHeaderDate(k); if(!d) return;
      if(!inRange(d,start,end)) return;
      const val=(typeof v==='string')?v.trim().toUpperCase():v;
      if(!(val===true || val==="TRUE")) return;
      if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Evaluator") return;
      add("Evaluator");
    });
  });

  const ctx = document.getElementById('roleChart').getContext('2d');
  resetChart(roleChart);
  roleChart = new Chart(ctx, {
    type:"pie",
    data:{ labels:Object.keys(counts), datasets:[{ data:Object.values(counts) }] },
    options:{ responsive:true, plugins:{ legend:{position:"bottom"} } }
  });
}

// Cumulative Progress: activity units over time
async function drawCumulative(member, start, end, roleFilter){
  const buckets={}; const bump=d=>{ const k=toISO(d); buckets[k]=(buckets[k]||0)+1; };

  const rtRows = cleanedRows(await fetchGViz("Role Taking"));
  (member ? rtRows.filter(r=>r.Name===member) : rtRows).forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const d=parseHeaderDate(k); if(!d) return;
      if(!inRange(d,start,end)) return;
      const val=String(v||"").trim(); if(!val) return;
      if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker" && roleFilter!=="Evaluator" && val!==roleFilter) return;
      bump(d);
    });
  });

  const spRows = cleanedRows(await fetchGViz("Speeches"));
  (member ? spRows.filter(r=>r.Name===member) : spRows).forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const d=parseHeaderDate(k); if(!d) return;
      if(!inRange(d,start,end)) return;
      if(!(v && String(v).trim())) return;
      if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker") return;
      bump(d);
    });
  });

  const evRows = cleanedRows(await fetchGViz("Evaluations"));
  (member ? evRows.filter(r=>r.Name===member) : evRows).forEach(row=>{
    Object.entries(row).forEach(([k,v])=>{
      if(k==="Name"||k==="Points") return;
      const d=parseHeaderDate(k); if(!d) return;
      if(!inRange(d,start,end)) return;
      const val=(typeof v==='string')?v.trim().toUpperCase():v;
      if(!(val===true || val==="TRUE")) return;
      if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Evaluator") return;
      bump(d);
    });
  });

  if(!roleFilter || roleFilter==="__ALL__"){
    for(const tab of ["Level Completions","Awards","ExCom & Sub.","Early Attendance","Other","Last Minute Roles"]){
      const rows = cleanedRows(await fetchGViz(tab));
      (member ? rows.filter(r=>r.Name===member) : rows).forEach(row=>{
        Object.entries(row).forEach(([k,v])=>{
          if(k==="Name"||k==="Points") return;
          const d=parseHeaderDate(k); if(!d) return;
          if(!inRange(d,start,end)) return;
          if(!(v && String(v).trim())) return;
          bump(d);
        });
      });
    }
  }

  const labels = Object.keys(buckets).sort();
  let cum=0;
  const values = labels.map(d=> (cum += buckets[d]));

  const ctx = document.getElementById('cumulativeChart').getContext('2d');
  resetChart(cumulativeChart);
  cumulativeChart = new Chart(ctx, {
    type:"line",
    data:{ labels, datasets:[{label:"Cumulative Activities", data:values, fill:false}] },
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

/** ===== Per-Meeting Details ===== **/
async function renderMeetingDetails(member, start, end, roleFilter){
  const container = document.getElementById('meetingSummaries');
  container.innerHTML = "";

  if(!member){ container.innerHTML = "<p>Select a member to see per-meeting details.</p>"; return; }

  const byMeeting = {};
  const add = (d, text)=>{ const k=toISO(d); if(!byMeeting[k]) byMeeting[k]=[]; byMeeting[k].push(text); };

  // Roles (Role Taking)
  const rtRow = cleanedRows(await fetchGViz("Role Taking")).find(r=>r.Name===member) || {};
  Object.entries(rtRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    const val=String(v||"").trim(); if(!val) return;
    if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker" && roleFilter!=="Evaluator" && val!==roleFilter) return;
    add(d, `Role: ${val}`);
  });

  // Speeches
  const spRow = cleanedRows(await fetchGViz("Speeches")).find(r=>r.Name===member) || {};
  Object.entries(spRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    const val=String(v||"").trim(); if(!val) return;
    if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Speaker") return;
    add(d, `Speaker: ${val}`);
  });

  // Evaluations
  const evRow = cleanedRows(await fetchGViz("Evaluations")).find(r=>r.Name===member) || {};
  Object.entries(evRow).forEach(([k,v])=>{
    if(k==="Name"||k==="Points") return;
    const d=parseHeaderDate(k); if(!d) return;
    if(!inRange(d,start,end)) return;
    const val=(typeof v==='string')?v.trim().toUpperCase():v;
    if(!(val===true || val==="TRUE")) return;
    if(roleFilter && roleFilter!=="__ALL__" && roleFilter!=="Evaluator") return;
    add(d, `Evaluator: ✓`);
  });

  // Other tabs (when no specific role filter)
  if(!roleFilter || roleFilter==="__ALL__"){
    for(const tab of ["Level Completions","Awards","ExCom & Sub.","Early Attendance","Other","Last Minute Roles"]){
      const row = cleanedRows(await fetchGViz(tab)).find(r=>r.Name===member) || {};
      Object.entries(row).forEach(([k,v])=>{
        if(k==="Name"||k==="Points") return;
        const d=parseHeaderDate(k); if(!d) return;
        if(!inRange(d,start,end)) return;
        const val=String(v||"").trim(); if(!val) return;
        add(d, `${tab}: ${val}`);
      });
    }
  }

  const days = Object.keys(byMeeting).sort();
  if(!days.length){ container.innerHTML = "<p>No meeting activity for current filters.</p>"; return; }
  days.forEach(day=>{
    const div = document.createElement('div');
    div.className="meeting panel";
    div.style.marginBottom="10px";
    div.innerHTML = `<strong>${day}</strong><ul>${byMeeting[day].map(x=>`<li>${x}</li>`).join("")}</ul>`;
    container.appendChild(div);
  });
}

/** ===== recompute engine ===== **/
async function recomputeAll(){
  clearError();
  const member = document.getElementById('memberSelect').value || "";
  const roleFilter = document.getElementById('roleFilter').value;
  const start = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null;
  const end   = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null;

  if(currentMode==="MEMBER" && !member){
    document.getElementById('kpiMeetings').textContent = "—";
    document.getElementById('kpiPoints').textContent = "—";
    document.getElementById('kpiRoles').textContent = "—";
    if(categoryChart) categoryChart.destroy();
    if(roleChart) roleChart.destroy();
    if(cumulativeChart) cumulativeChart.destroy();
    document.getElementById('meetingSummaries').innerHTML = "<p>Select a member to see details.</p>";
  }else{
    await updateKPIs(member || null, start, end, roleFilter);
    await drawCategoryChart(member || null);
    await drawRoleChart(member || null, start, end, roleFilter);
    await drawCumulative(member || null, start, end, roleFilter);
    await renderMeetingDetails(member || null, start, end, roleFilter);
  }

  const activeBtn = document.querySelector('.tab-btn.active');
  if (activeBtn){
    await loadDetailTable(activeBtn.dataset.sheet, member || null);
  }
}

/** ===== Date defaults from Role Taking ===== **/
async function setDefaultDateRange(){
  const rt = await fetchGViz("Role Taking");
  const dates = dateColumnsFrom(rt).map(parseHeaderDate).filter(Boolean).sort((a,b)=>a-b);
  if(!dates.length) return;
  document.getElementById('startDate').value = toISO(dates[0]);
  document.getElementById('endDate').value = toISO(dates[dates.length-1]);
}

/** ===== init ===== **/
document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    // Preload core sheets needed for filters/metrics
    await Promise.all([
      fetchGViz("Total"),
      fetchGViz("Role Taking"),
      fetchGViz("Speeches"),
      fetchGViz("Evaluations"),
      fetchGViz("Summary")
    ]);

    await populateMembers();
    await populateRoleFilter();
    await setDefaultDateRange();
    await buildLeaderboard();

    // Default: All Members mode; show Total tab
    await loadDetailTable('Total', null);
    await recomputeAll();

    // filters
    document.getElementById('memberSelect').addEventListener('change', recomputeAll);
    document.getElementById('roleFilter').addEventListener('change', recomputeAll);
    document.getElementById('startDate').addEventListener('change', recomputeAll);
    document.getElementById('endDate').addEventListener('change', recomputeAll);

    // tabs
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const member = document.getElementById('memberSelect').value || null;
        await loadDetailTable(btn.dataset.sheet, member);
      });
    });

    // mode toggle
    document.getElementById('modeAll').addEventListener('click', async ()=>{
      currentMode = "ALL";
      document.getElementById('modeAll').classList.add('active');
      document.getElementById('modeMember').classList.remove('active');
      await recomputeAll();
    });
    document.getElementById('modeMember').addEventListener('click', async ()=>{
      currentMode = "MEMBER";
      document.getElementById('modeMember').classList.add('active');
      document.getElementById('modeAll').classList.remove('active');
      await recomputeAll();
    });

  }catch(e){
    showError("Initialization error: "+ (e?.message || e));
    console.error(e);
  }
});
</script>
</body>
</html>
