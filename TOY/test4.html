<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Toastmasters Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --tm-maroon: #772432;
      --tm-navy: #004165;
      --tm-gold: #d9a441;
      --tm-gray: #f5f5f5;
    }
    body { font-family: Arial, sans-serif; margin: 0; background: var(--tm-gray); }
    header { background: var(--tm-navy); color: white; padding: 15px; display: flex; align-items: center; }
    header img { height: 40px; margin-right: 15px; }
    h1 { font-size: 1.5em; margin: 0; }
    .container { padding: 20px; }
    .kpi { display: inline-block; margin: 10px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);} 
    .filters { margin: 20px 0; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    select, input { margin: 5px; padding: 5px; }
    canvas { margin: 20px 0; background: white; padding: 10px; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white;}
    th, td { padding: 8px; border: 1px solid #ccc; }
    th { background: var(--tm-navy); color: white; }
    .badge { padding: 2px 6px; border-radius: 6px; color: white; font-size: 0.85em; }
    .role-speech { background: darkgreen; }
    .role-evaluator { background: darkorange; }
    .role-general { background: var(--tm-navy); }
    .tab { display: inline-block; margin: 5px; padding: 8px 15px; background: var(--tm-gold); color: white; border-radius: 8px; cursor: pointer; }
    .tab.active { background: var(--tm-maroon); }
    .tabcontent { display: none; }
    .tabcontent.active { display: block; }
  </style>
</head>
<body>
  <header>
    <img src="https://www.toastmasters.org/-/media/toastmasters/branding-logos/logos/brand-mark.png" alt="TM Logo">
    <h1>Toastmasters Dashboard</h1>
  </header>

  <div class="container">
    <div class="filters">
      <label>Select member:</label>
      <select id="memberSelect"><option>— Select —</option></select>
      <label>Filter by role:</label>
      <select id="roleSelect"><option>All roles</option></select>
      <label>From:</label><input type="date" id="fromDate">
      <label>To:</label><input type="date" id="toDate">
    </div>

    <div id="kpis">
      <div class="kpi"><strong>Meetings Counted</strong><br><span id="meetingsCount">0</span></div>
      <div class="kpi"><strong>Total Points</strong><br><span id="totalPoints">0</span></div>
      <div class="kpi"><strong>Distinct Roles</strong><br><span id="distinctRoles">0</span></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="categories">Categories</div>
      <div class="tab" data-tab="details">Details</div>
      <div class="tab" data-tab="leaderboard">Leaderboard</div>
    </div>

    <div id="categories" class="tabcontent active">
      <h2>Category Breakdown</h2>
      <canvas id="breakdownChart"></canvas>
    </div>

    <div id="details" class="tabcontent">
      <h2>Member Progress</h2>
      <canvas id="progressChart"></canvas>
      <h2>Details</h2>
      <table id="detailsTable">
        <thead><tr><th>Date</th><th>Role</th><th>Points</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="leaderboard" class="tabcontent">
      <h2>Leaderboard (Club)</h2>
      <table id="leaderboardTable">
        <thead><tr><th>Name</th><th>Points</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const sheetUrls = {
  "Summary": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1556398249&single=true&output=csv",
  "Total": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1939085341&single=true&output=csv",
  "Early Attendance": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1928408168&single=true&output=csv",
  "Role Taking": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=23380471&single=true&output=csv",
  "Speeches": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=170161438&single=true&output=csv",
  "Evaluations": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=335593996&single=true&output=csv"
};

let sheets = {};

function loadSheets() {
  let loaded = 0, total = Object.keys(sheetUrls).length;
  for (let [name, url] of Object.entries(sheetUrls)) {
    Papa.parse(url, {
      download: true, header: true, skipEmptyLines: true,
      complete: function(results) {
        sheets[name] = results.data;
        loaded++;
        if (loaded === total) initDashboard();
      }
    });
  }
}

function initDashboard() {
  // Populate members from Total sheet
  let members = sheets["Total"].map(r => r.Name).filter(n => n && n !== "Name");
  let memberSelect = document.getElementById("memberSelect");
  members.forEach(m => {
    let opt = document.createElement("option"); opt.text = m; opt.value = m;
    memberSelect.add(opt);
  });

  // Leaderboard
  let tbody = document.querySelector("#leaderboardTable tbody");
  sheets["Summary"].forEach(r => {
    if (r.Name && r.Points) {
      let tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.Name}</td><td>${r.Points}</td>`;
      tbody.appendChild(tr);
    }
  });

  document.getElementById("memberSelect").addEventListener("change", updateDashboard);
  document.getElementById("roleSelect").addEventListener("change", updateDashboard);
  document.getElementById("fromDate").addEventListener("change", updateDashboard);
  document.getElementById("toDate").addEventListener("change", updateDashboard);

  // Tabs
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tabcontent").forEach(c => c.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(tab.dataset.tab).classList.add("active");
    });
  });
}

function updateDashboard() {
  let member = document.getElementById("memberSelect").value;
  if (member === "— Select —") return;

  // Repopulate role filter for this member
  let roleSelect = document.getElementById("roleSelect");
  roleSelect.innerHTML = "<option>All roles</option>";
  let memberRoles = new Set();
  sheets["Role Taking"].forEach(r => {
    if (r.Name === member) {
      Object.values(r).forEach(val => { if (val && val !== "Name" && val !== "Points") memberRoles.add(val); });
    }
  });
  sheets["Speeches"].forEach(r => { if (r.Name === member && Object.values(r).some(v => v && v.trim())) memberRoles.add("Speaker"); });
  sheets["Evaluations"].forEach(r => { if (r.Name === member && Object.values(r).some(v => v === "TRUE")) memberRoles.add("Evaluator"); });
  memberRoles.forEach(role => { let opt = document.createElement("option"); opt.text = role; opt.value = role; roleSelect.add(opt); });

  let roleFilter = document.getElementById("roleSelect").value;
  let fromDate = document.getElementById("fromDate").value;
  let toDate = document.getElementById("toDate").value;

  // Total Points
  let totalRow = sheets["Total"].find(r => r.Name === member);
  let totalPoints = totalRow ? +totalRow.Points || 0 : 0;
  document.getElementById("totalPoints").innerText = totalPoints;

  // Meetings Counted
  let meetings = 0;
  sheets["Early Attendance"].forEach(r => {
    if (r.Name === member) {
      Object.entries(r).forEach(([key, val]) => {
        if (key !== "Name" && val && val !== "A" && val !== "E") meetings++;
      });
    }
  });
  document.getElementById("meetingsCount").innerText = meetings;

  // Distinct Roles
  let distinct = memberRoles;
  document.getElementById("distinctRoles").innerText = distinct.size;

  // Charts
  drawBreakdownChart(totalRow);
  drawProgressChart(member, fromDate, toDate, roleFilter);

  // Details table
  drawDetailsTable(member, fromDate, toDate, roleFilter);
}

function drawBreakdownChart(row) {
  if (!row) return;
  let labels = Object.keys(row).slice(2);
  let values = labels.map(k => +row[k] || 0);
  let ctx = document.getElementById("breakdownChart").getContext("2d");
  if (window.breakdownChart) window.breakdownChart.destroy();
  window.breakdownChart = new Chart(ctx, {
    type: 'pie',
    data: { labels: labels, datasets: [{ data: values, backgroundColor:["#772432","#004165","#d9a441","#999"] }] }
  });
}

function drawProgressChart(member, fromDate, toDate, roleFilter) {
  let dates = [], counts = [];
  let rows = sheets["Early Attendance"].find(r => r.Name === member);
  if (!rows) return;
  let cols = Object.keys(rows).slice(2);
  cols.forEach((c,i) => {
    let val = rows[c];
    if (val && val !== "A" && val !== "E") {
      if ((!fromDate || c >= fromDate) && (!toDate || c <= toDate)) {
        dates.push(c);
        counts.push(i+1);
      }
    }
  });
  let ctx = document.getElementById("progressChart").getContext("2d");
  if (window.progressChart) window.progressChart.destroy();
  window.progressChart = new Chart(ctx, {
    type: 'line',
    data: { labels: dates, datasets: [{ label:"Meetings", data: counts, fill:false, borderColor:"#004165"}]}
  });
}

function drawDetailsTable(member, fromDate, toDate, roleFilter) {
  let tbody = document.querySelector("#detailsTable tbody");
  tbody.innerHTML = "";
  // Example: populate from Role Taking + Speeches + Evaluations
  let addRow = (date, role, points) => {
    if ((roleFilter === "All roles" || roleFilter === role) && (!fromDate || date >= fromDate) && (!toDate || date <= toDate)) {
      let badgeClass = role === "Speaker" ? "role-speech" : (role === "Evaluator" ? "role-evaluator" : "role-general");
      let tr = document.createElement("tr");
      tr.innerHTML = `<td>${date}</td><td><span class="badge ${badgeClass}">${role}</span></td><td>${points}</td>`;
      tbody.appendChild(tr);
    }
  };
  sheets["Role Taking"].forEach(r => { if (r.Name === member) Object.entries(r).forEach(([date, role]) => { if (date!=="Name" && role) addRow(date, role, r.Points||0); }); });
  sheets["Speeches"].forEach(r => { if (r.Name === member) Object.entries(r).forEach(([date, v]) => { if (date!=="Name" && v) addRow(date, "Speaker", r.Points||0); }); });
  sheets["Evaluations"].forEach(r => { if (r.Name === member) Object.entries(r).forEach(([date, v]) => { if (date!=="Name" && v==="TRUE") addRow(date, "Evaluator", r.Points||0); }); });
}

loadSheets();
</script>
</body>
</html>
