<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Toastmasters of the Year Tracker</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:20px; }
    header { background:#004165; color:white; padding:15px; border-radius:8px; }
    h1 { margin:0; font-size:22px; }
    .filters, .stats { margin:15px 0; }
    .filters select, .filters input { margin-right:10px; }
    .stats { display:flex; gap:20px; }
    .stat-card { background:white; padding:10px 15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .tab-buttons { margin:15px 0; }
    .tab-buttons button { margin-right:8px; padding:6px 12px; border:none; border-radius:5px; background:#004165; color:white; cursor:pointer; }
    .tab-buttons button.active { background:#d71e28; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    table th, table td { border:1px solid #ccc; padding:6px; }
  </style>
</head>
<body>
<header>
  <h1>Toastmasters of the Year Tracker</h1>
</header>

<div class="filters">
  <label>Select member:
    <select id="memberSelect"><option value="">— Select —</option></select>
  </label>
  <label>Filter by role:
    <select id="roleSelect"><option value="">All roles</option></select>
  </label>
  <label>Start date: <input type="date" id="startDate"></label>
  <label>End date: <input type="date" id="endDate"></label>
</div>

<div class="stats">
  <div class="stat-card">Meetings Counted: <span id="meetingsCount">0</span></div>
  <div class="stat-card">Total Points: <span id="totalPoints">0</span></div>
  <div class="stat-card">Distinct Roles: <span id="distinctRoles">0</span></div>
</div>

<div class="tab-buttons">
  <button class="tab-btn active" data-tab="total">Total</button>
  <button class="tab-btn" data-tab="early">Early Attendance</button>
  <button class="tab-btn" data-tab="roles">Role Taking</button>
  <button class="tab-btn" data-tab="speeches">Speeches</button>
  <button class="tab-btn" data-tab="evals">Evaluations</button>
  <button class="tab-btn" data-tab="leaderboard">Leaderboard</button>
</div>

<div id="total" class="tab-content active">
  <h2>Total Breakdown</h2>
  <table id="totalTable"></table>
</div>

<div id="early" class="tab-content">
  <h2>Early Attendance</h2>
  <table id="earlyTable"></table>
</div>

<div id="roles" class="tab-content">
  <h2>Role Taking</h2>
  <table id="rolesTable"></table>
</div>

<div id="speeches" class="tab-content">
  <h2>Speeches</h2>
  <table id="speechesTable"></table>
</div>

<div id="evals" class="tab-content">
  <h2>Evaluations</h2>
  <table id="evalsTable"></table>
</div>

<div id="leaderboard" class="tab-content">
  <h2>Leaderboard</h2>
  <table id="leaderboardTable"></table>
</div>

<script>
const sheetUrls = {
  "Summary": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1556398249&single=true&output=csv",
  "Total": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1939085341&single=true&output=csv",
  "Early Attendance": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1928408168&single=true&output=csv",
  "Role Taking": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=23380471&single=true&output=csv",
  "Speeches": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=170161438&single=true&output=csv",
  "Evaluations": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=335593996&single=true&output=csv"
};

let sheets = {};

function loadSheets() {
  Object.entries(sheetUrls).forEach(([name,url]) => {
    Papa.parse(url, {
      download:true,
      header:true,
      skipEmptyLines:true,
      beforeFirstChunk: function(chunk) {
        let rows = chunk.split(/\r?\n/);
        if(name==="Total") {
          rows[0] = rows[1]; // use row 2 as headers
          rows.splice(1,1);  // remove row 2
        } else {
          rows.splice(1,1); // remove row 2 with meeting numbers
        }
        return rows.join("\n");
      },
      complete: function(results) {
        sheets[name] = results.data;
        console.log("Loaded:", name, results.data);
        if(name==="Total") populateMembers(results.data);
        if(name==="Summary") populateLeaderboard(results.data);
        if(name==="Total") populateTable("#totalTable", results.data);
        if(name==="Early Attendance") populateTable("#earlyTable", results.data);
        if(name==="Role Taking") populateTable("#rolesTable", results.data);
        if(name==="Speeches") populateTable("#speechesTable", results.data);
        if(name==="Evaluations") populateTable("#evalsTable", results.data);
      }
    });
  });
}

function populateMembers(data) {
  let names = [...new Set(data.map(r=>r.Name).filter(n=>n))];
  let sel = $("#memberSelect");
  names.forEach(n=> sel.append(`<option value="${n}">${n}</option>`));
}

function populateLeaderboard(data) {
  populateTable("#leaderboardTable", data);
}

function populateTable(selector, data) {
  if(!data || data.length===0) return;
  let cols = Object.keys(data[0]);
  let html = "<thead><tr>"+cols.map(c=>`<th>${c}</th>`).join("")+"</tr></thead><tbody>";
  data.forEach(row=>{
    html += "<tr>"+cols.map(c=>`<td>${row[c]||""}</td>`).join("")+"</tr>";
  });
  html += "</tbody>";
  $(selector).html(html).DataTable();
}

$(document).on("click", ".tab-btn", function(){
  $(".tab-btn").removeClass("active");
  $(this).addClass("active");
  $(".tab-content").removeClass("active");
  $("#"+$(this).data("tab")).addClass("active");
});

$(document).ready(loadSheets);
</script>
</body>
</html>
