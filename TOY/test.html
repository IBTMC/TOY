<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Toastmasters Club Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- jQuery, DataTables, Chart.js -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #f8f9fa; }
  header { background: #004165; color: white; padding: 10px 20px;
           display: flex; justify-content: space-between; align-items: center; }
  header img { height: 50px; }
  .container { padding: 20px; }
  .panel { background: white; border-radius: 10px; padding: 15px; margin: 15px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.1);}
  .kpis { display: flex; gap: 20px; }
  .kpis .panel { flex: 1; text-align: center; font-size: 1.2em; }
  .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
  .tabs button.active { background: #004165; color: white; }
  footer { text-align: center; padding: 10px; font-size: 0.9em; color: #555; }
  .topbar { display: flex; justify-content: space-between; align-items: center; }
  .filters { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
  select, input { padding: 5px; }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="https://www.toastmasters.org/-/media/toastmasters/brand-portal/files/logos/official-logo/primary-logo-color.ashx" alt="Toastmasters International">
    <h1>Toastmasters Club Dashboard</h1>
  </div>
  <img src="club-logo.png" alt="Club Logo">
</header>

<div class="container">
  <div class="topbar">
    <div class="mode-toggle">
      <span style="font-weight:700;">Display:</span>
      <button id="modeAll" class="active">All Members</button>
      <button id="modeMember">Member Only</button>
    </div>
  </div>

  <div class="filters panel">
    <div>
      <label>Select member</label><br>
      <select id="memberSelect"><option value="">— Select —</option></select>
    </div>
    <div>
      <label>Filter by role (optional)</label><br>
      <select id="roleFilter"><option value="">All roles</option></select>
    </div>
    <div>
      <label>Start date</label><br>
      <input type="date" id="startDate">
    </div>
    <div>
      <label>End date</label><br>
      <input type="date" id="endDate">
    </div>
  </div>

  <div class="kpis">
    <div class="panel"><div>Meetings Counted</div><div id="kpiMeetings">0</div></div>
    <div class="panel"><div>Total Points</div><div id="kpiPoints">0</div></div>
    <div class="panel"><div>Distinct Roles</div><div id="kpiRoles">0</div></div>
  </div>

  <div class="charts">
    <div class="panel"><h3>Category Breakdown</h3><canvas id="categoryChart"></canvas></div>
    <div class="panel"><h3>Roles Breakdown</h3><canvas id="roleChart"></canvas></div>
    <div class="panel" style="grid-column: span 2;"><h3>Cumulative Progress</h3><canvas id="cumulativeChart"></canvas></div>
  </div>

  <div class="panel">
    <h3>Per-Meeting Details</h3>
    <div id="meetingDetails"></div>
  </div>

  <div class="panel">
    <div class="tabs">
      <button class="tab-btn active" data-sheet="Total">Total</button>
      <button class="tab-btn" data-sheet="Role Taking">Role Taking</button>
      <button class="tab-btn" data-sheet="Speeches">Speeches</button>
      <button class="tab-btn" data-sheet="Evaluations">Evaluations</button>
      <button class="tab-btn" data-sheet="Level Completions">Level Completions</button>
      <button class="tab-btn" data-sheet="Awards">Awards</button>
      <button class="tab-btn" data-sheet="ExCom & Sub.">ExCom & Sub.</button>
      <button class="tab-btn" data-sheet="Early Attendance">Early Attendance</button>
      <button class="tab-btn" data-sheet="Other">Other</button>
      <button class="tab-btn" data-sheet="Last Minute Roles">Last Minute Roles</button>
    </div>
    <table id="detailTable" class="display" style="width:100%"></table>
  </div>

  <footer>Live from Google Sheets • Toastmasters compliant</footer>
</div>

<script>
const SHEET_ID = "2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx";
const DETAIL_TABS = ["Total","Role Taking","Speeches","Evaluations","Level Completions","Awards","ExCom & Sub.","Early Attendance","Other","Last Minute Roles"];
let cache = {};
let currentMode = "ALL";
let categoryChart, roleChart, cumulativeChart;

async function fetchGViz(sheetName) {
  if (cache[sheetName]) return cache[sheetName];
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&tq=select%20*`;
  const res = await fetch(url);
  const txt = await res.text();
  const match = txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);/);
  if (!match) return [];
  const json = JSON.parse(match[1]);
  const cols = json.table.cols.map(c => c.label);
  const rows = json.table.rows.map(r => {
    const obj = {};
    (r.c || []).forEach((cell, i) => {
      obj[cols[i] || `col${i}`] = cell ? (cell.f ?? cell.v ?? "") : "";
    });
    return obj;
  });
  cache[sheetName] = rows;
  return rows;
}

function cleanedRows(rows) {
  return rows.filter(r => r.Name && String(r.Name).trim());
}

async function populateMemberFilter() {
  const rows = cleanedRows(await fetchGViz("Total"));
  const members = [...new Set(rows.map(r => r.Name))];
  const sel = document.getElementById("memberSelect");
  sel.innerHTML = `<option value="">— Select —</option>` + members.map(m => `<option>${m}</option>`).join("");
}
async function populateRoleFilter() {
  const rows = await fetchGViz("Role Taking");
  const roles = new Set();
  rows.forEach(r => { Object.values(r).forEach(v => { if (v && typeof v === "string") roles.add(v); }); });
  const sel = document.getElementById("roleFilter");
  sel.innerHTML = `<option value="">All roles</option>` + [...roles].map(r => `<option>${r}</option>`).join("");
}
async function loadDetailTable(sheetName, member) {
  const rows = await fetchGViz(sheetName);
  const headers = Object.keys(rows[0] || {});
  const data = rows.filter(r => !member || r.Name === member).map(r => headers.map(h => r[h]));
  if ($.fn.dataTable.isDataTable("#detailTable")) $("#detailTable").DataTable().destroy();
  $("#detailTable").empty();
  $("#detailTable").DataTable({ data, columns: headers.map(h => ({title:h})) });
}

async function recomputeAll() {
  const member = document.getElementById("memberSelect").value || null;
  await loadDetailTable(document.querySelector(".tab-btn.active").dataset.sheet, member);
  // KPIs etc can be filled here
}

async function initAll() {
  await Promise.all(DETAIL_TABS.map(fn => fetchGViz(fn)));
  await fetchGViz("Summary");
  await populateMemberFilter();
  await populateRoleFilter();
  await recomputeAll();

  document.querySelectorAll("#memberSelect, #roleFilter, #startDate, #endDate").forEach(el => el.addEventListener("change", recomputeAll));
  document.querySelectorAll(".tab-btn").forEach(btn => btn.addEventListener("click", async () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    await recomputeAll();
  }));
  document.getElementById("modeAll").addEventListener("click", async () => {
    currentMode="ALL"; document.getElementById("modeAll").classList.add("active");
    document.getElementById("modeMember").classList.remove("active"); recomputeAll();
  });
  document.getElementById("modeMember").addEventListener("click", async () => {
    currentMode="MEMBER"; document.getElementById("modeMember").classList.add("active");
    document.getElementById("modeAll").classList.remove("active"); recomputeAll();
  });
}

document.addEventListener("DOMContentLoaded", initAll);
</script>
</body>
</html>
