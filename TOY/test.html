<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Toastmasters Dashboard</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
    header { background:#772432; color:#fff; padding:10px 20px; display:flex; align-items:center; }
    header img { height:50px; margin-right:20px; }
    header h1 { flex:1; font-size:20px; }
    .container { padding:20px; }
    .filters { margin-bottom:20px; display:flex; gap:20px; flex-wrap:wrap; }
    .kpis { display:flex; gap:20px; margin-bottom:20px; }
    .kpi { flex:1; background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center; }
    .tabs { margin-bottom:20px; }
    .tabs button { padding:10px 15px; border:none; background:#004165; color:#fff; cursor:pointer; }
    .tabs button.active { background:#0072ce; }
    .tabcontent { display:none; }
    .tabcontent.active { display:block; }
    canvas { background:#fff; border-radius:8px; padding:10px; }
  </style>
</head>
<body>
<header>
  <img src="https://www.toastmasters.org/~/media/Toastmasters/Branding/logo/Toastmasters_Logo_Horizontal_RGB.ashx" alt="TM Logo">
  <h1>Toastmasters Club Dashboard</h1>
  <img src="https://via.placeholder.com/120x50.png?text=Club+Logo" alt="Club Logo">
</header>

<div class="container">
  <div class="filters">
    <label> Select Member:
      <select id="memberSelect"><option value="">— Select —</option></select>
    </label>
    <label> Filter by Role:
      <select id="roleSelect"><option value="">All Roles</option></select>
    </label>
    <label> Start date: <input type="date" id="startDate"> </label>
    <label> End date: <input type="date" id="endDate"> </label>
  </div>

  <div class="kpis">
    <div class="kpi"><h2 id="meetingsCount">0</h2><p>Meetings Counted</p></div>
    <div class="kpi"><h2 id="totalPoints">0</h2><p>Total Points</p></div>
    <div class="kpi"><h2 id="distinctRoles">0</h2><p>Distinct Roles</p></div>
  </div>

  <div class="tabs">
    <button class="tablink active" data-tab="leaderboard">Leaderboard</button>
    <button class="tablink" data-tab="category">Category Breakdown</button>
    <button class="tablink" data-tab="progress">Cumulative Progress</button>
    <button class="tablink" data-tab="details">Per-Meeting Details</button>
  </div>

  <div id="leaderboard" class="tabcontent active">
    <table id="leaderboardTable" class="display"></table>
  </div>
  <div id="category" class="tabcontent">
    <canvas id="categoryChart"></canvas>
  </div>
  <div id="progress" class="tabcontent">
    <canvas id="progressChart"></canvas>
  </div>
  <div id="details" class="tabcontent">
    <table id="detailTable" class="display"></table>
  </div>
</div>

<script>
const baseUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/gviz/tq?sheet=";
const sheetNames = ["Summary","Total","Early Attendance","Role Taking","Last Minute Roles","Speeches","Evaluations","Level Completions","Awards","ExCom & Sub."];

let sheetsData = {};
let rolesList = new Set();

async function loadSheet(sheetName) {
  const url = baseUrl + encodeURIComponent(sheetName);
  const response = await fetch(url);
  const text = await response.text();
  const json = JSON.parse(text.substr(47).slice(0,-2));
  return json.table;
}

async function init() {
  for (let sheet of sheetNames) {
    sheetsData[sheet] = await loadSheet(sheet);
  }
  populateMembers();
  populateRoles();
  renderLeaderboard();
  attachEvents();
}

function populateMembers() {
  const table = sheetsData["Total"];
  const memberSelect = $("#memberSelect");
  table.rows.forEach(row => {
    const name = row.c[0] ? row.c[0].v : null;
    if (name && name !== "Name") {
      memberSelect.append(`<option value="${name}">${name}</option>`);
    }
  });
}

function populateRoles() {
  const roleSheet = sheetsData["Role Taking"];
  roleSheet.rows.slice(2).forEach(r => {
    r.c.slice(2).forEach(cell => {
      if (cell && cell.v) rolesList.add(cell.v);
    });
  });
  // Add special roles
  rolesList.add("Speaker");
  rolesList.add("Evaluator");
  rolesList.forEach(role => {
    $("#roleSelect").append(`<option value="${role}">${role}</option>`);
  });
}

function renderLeaderboard() {
  const table = sheetsData["Summary"];
  const cols = table.cols.map(c => c.label);
  const data = table.rows.map(r => r.c.map(c => c ? c.v : ""));
  $("#leaderboardTable").DataTable({
    data: data,
    columns: cols.map(c => ({ title:c })),
    destroy: true
  });
}

function attachEvents() {
  $(".tablink").on("click", function(){
    $(".tablink").removeClass("active");
    $(this).addClass("active");
    $(".tabcontent").removeClass("active");
    $("#" + $(this).data("tab")).addClass("active");
  });
  $("#memberSelect").on("change", updateMemberView);
}

function updateMemberView() {
  const member = $("#memberSelect").val();
  if (!member) return;
  updateKPIs(member);
}

function updateKPIs(member) {
  const totalSheet = sheetsData["Total"];
  let totalPoints = 0;
  totalSheet.rows.forEach(r => {
    if (r.c[0] && r.c[0].v === member) {
      totalPoints = r.c[1] ? r.c[1].v : 0;
    }
  });
  $("#totalPoints").text(totalPoints);

  // Meetings Counted
  const eaSheet = sheetsData["Early Attendance"];
  let count = 0;
  eaSheet.rows.forEach(r => {
    if (r.c[0] && r.c[0].v === member) {
      r.c.slice(2).forEach(cell => {
        if (cell && cell.v && cell.v !== "A" && cell.v !== "E") count++;
      });
    }
  });
  $("#meetingsCount").text(count);

  // Distinct Roles
  let memberRoles = new Set();
  const roleTaking = sheetsData["Role Taking"];
  roleTaking.rows.forEach(r => {
    if (r.c[0] && r.c[0].v === member) {
      r.c.slice(2).forEach(cell => { if(cell&&cell.v) memberRoles.add(cell.v); });
    }
  });
  const lmRoles = sheetsData["Last Minute Roles"];
  lmRoles.rows.forEach(r => {
    if (r.c[0] && r.c[0].v === member) {
      r.c.slice(2).forEach(cell => { if(cell&&cell.v) memberRoles.add(cell.v); });
    }
  });
  const speeches = sheetsData["Speeches"];
  speeches.rows.forEach(r => {
    if (r.c[0] && r.c[0].v === member) {
      r.c.slice(2).forEach(cell => { if(cell&&cell.v) memberRoles.add("Speaker"); });
    }
  });
  const evals = sheetsData["Evaluations"];
  evals.rows.forEach(r => {
    if (r.c[0] && r.c[0].v === member) {
      r.c.slice(2).forEach(cell => { if(cell&&cell.v==="TRUE") memberRoles.add("Evaluator"); });
    }
  });
  $("#distinctRoles").text(memberRoles.size);
}

init();
</script>
</body>
</html>
