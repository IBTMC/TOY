<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Toastmasters Dashboard</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
    header { background:#772432; color:#fff; padding:10px 20px; display:flex; align-items:center; }
    header img { height:50px; margin-right:20px; }
    header h1 { flex:1; font-size:20px; }
    .container { padding:20px; }
    .filters { margin-bottom:20px; display:flex; gap:20px; flex-wrap:wrap; }
    .kpis { display:flex; gap:20px; margin-bottom:20px; }
    .kpi { flex:1; background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center; }
    .tabs { margin-bottom:20px; }
    .tabs button { padding:10px 15px; border:none; background:#004165; color:#fff; cursor:pointer; }
    .tabs button.active { background:#0072ce; }
    .tabcontent { display:none; }
    .tabcontent.active { display:block; }
    canvas { background:#fff; border-radius:8px; padding:10px; }
  </style>
</head>
<body>
<header>
  <img src="https://www.toastmasters.org/~/media/Toastmasters/Branding/logo/Toastmasters_Logo_Horizontal_RGB.ashx" alt="TM Logo">
  <h1>Toastmasters Club Dashboard</h1>
  <img src="https://via.placeholder.com/120x50.png?text=Club+Logo" alt="Club Logo">
</header>

<div class="container">
  <div class="filters">
    <label> Select Member:
      <select id="memberSelect"><option value="">— Select —</option></select>
    </label>
    <label> Filter by Role:
      <select id="roleSelect"><option value="">All Roles</option></select>
    </label>
    <label> Start date: <input type="date" id="startDate"> </label>
    <label> End date: <input type="date" id="endDate"> </label>
  </div>

  <div class="kpis">
    <div class="kpi"><h2 id="meetingsCount">0</h2><p>Meetings Counted</p></div>
    <div class="kpi"><h2 id="totalPoints">0</h2><p>Total Points</p></div>
    <div class="kpi"><h2 id="distinctRoles">0</h2><p>Distinct Roles</p></div>
  </div>

  <div class="tabs">
    <button class="tablink active" data-tab="leaderboard">Leaderboard</button>
    <button class="tablink" data-tab="category">Category Breakdown</button>
    <button class="tablink" data-tab="progress">Cumulative Progress</button>
    <button class="tablink" data-tab="details">Per-Meeting Details</button>
  </div>

  <div id="leaderboard" class="tabcontent active">
    <table id="leaderboardTable" class="display"></table>
  </div>
  <div id="category" class="tabcontent">
    <canvas id="categoryChart"></canvas>
  </div>
  <div id="progress" class="tabcontent">
    <canvas id="progressChart"></canvas>
  </div>
  <div id="details" class="tabcontent">
    <table id="detailTable" class="display"></table>
  </div>
</div>

<script>
const sheetLinks = {
  "Summary": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1556398249&single=true&output=csv",
  "Total": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1939085341&single=true&output=csv",
  "Early Attendance": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1928408168&single=true&output=csv",
  "Role Taking": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=23380471&single=true&output=csv",
  "Last Minute Roles": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=10890228&single=true&output=csv",
  "Speeches": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=170161438&single=true&output=csv",
  "Evaluations": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=335593996&single=true&output=csv",
  "Level Completions": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=1646576393&single=true&output=csv",
  "Awards": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=302763050&single=true&output=csv",
  "ExCom & Sub.": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=710668362&single=true&output=csv",
  "Contests": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=859627444&single=true&output=csv",
  "Table Topics": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz-oWABE-EvDz6gal8sPWQ8bfWdikK57YJLPtfVHVrUA9yCHOzBRgXgJMpizQKMlAVsO9Ud4XUlflx/pub?gid=618267332&single=true&output=csv"
};

let sheetsData = {};
let rolesList = new Set();
let categoryChart, progressChart;

async function loadSheet(name, url) {
  return new Promise((resolve) => {
    Papa.parse(url, {
      download: true,
      header: true,
      complete: (results) => {
        sheetsData[name] = results.data;
        resolve();
      }
    });
  });
}

async function init() {
  for (const [name, url] of Object.entries(sheetLinks)) {
    await loadSheet(name, url);
  }
  populateMembers();
  populateRoles();
  renderLeaderboard();
  attachEvents();
}

function populateMembers() {
  const total = sheetsData["Total"];
  total.forEach(row => {
    if (row["Name"]) {
      $("#memberSelect").append(`<option value="${row["Name"]}">${row["Name"]}</option>`);
    }
  });
}

function populateRoles() {
  ["Role Taking","Last Minute Roles"].forEach(sheetName => {
    sheetsData[sheetName].forEach(r => {
      Object.values(r).slice(2).forEach(val => { if(val) rolesList.add(val); });
    });
  });
  sheetsData["Speeches"].forEach(r => { if(r["Name"]) rolesList.add("Speaker"); });
  sheetsData["Evaluations"].forEach(r => { if(r["Name"]) rolesList.add("Evaluator"); });
  rolesList.forEach(role => {
    $("#roleSelect").append(`<option value="${role}">${role}</option>`);
  });
}

function renderLeaderboard() {
  const summary = sheetsData["Summary"];
  const cols = Object.keys(summary[0] || {});
  const data = summary.map(r => cols.map(c => r[c]));
  $("#leaderboardTable").DataTable({
    data: data,
    columns: cols.map(c => ({title:c})),
    destroy:true
  });
}

function attachEvents() {
  $(".tablink").on("click", function(){
    $(".tablink").removeClass("active");
    $(this).addClass("active");
    $(".tabcontent").removeClass("active");
    $("#" + $(this).data("tab")).addClass("active");
  });
  $("#memberSelect").on("change", updateMemberView);
}

function updateMemberView() {
  const member = $("#memberSelect").val();
  if (!member) return;
  updateKPIs(member);
  updateCategoryChart(member);
  updateProgressChart(member);
}

function updateKPIs(member) {
  const total = sheetsData["Total"];
  const row = total.find(r => r["Name"] === member);
  $("#totalPoints").text(row ? row["Points"] : 0);

  const ea = sheetsData["Early Attendance"];
  let count=0;
  ea.forEach(r => {
    if(r["Name"]===member){
      Object.values(r).slice(2).forEach(v=>{
        if(v && v!=="A" && v!=="E") count++;
      });
    }
  });
  $("#meetingsCount").text(count);

  let memberRoles=new Set();
  ["Role Taking","Last Minute Roles"].forEach(sheet=>{
    sheetsData[sheet].forEach(r=>{
      if(r["Name"]===member){
        Object.values(r).slice(2).forEach(v=>{ if(v) memberRoles.add(v); });
      }
    });
  });
  sheetsData["Speeches"].forEach(r=>{ if(r["Name"]===member) memberRoles.add("Speaker"); });
  sheetsData["Evaluations"].forEach(r=>{ if(r["Name"]===member) memberRoles.add("Evaluator"); });
  $("#distinctRoles").text(memberRoles.size);
}

function updateCategoryChart(member) {
  const total = sheetsData["Total"];
  const row = total.find(r=>r["Name"]===member);
  if(!row) return;
  const labels = Object.keys(row).filter(k=>k!=="Name" && k!=="Points");
  const values = labels.map(l=>parseInt(row[l])||0);
  if(categoryChart) categoryChart.destroy();
  categoryChart = new Chart(document.getElementById("categoryChart"),{
    type:"pie",
    data:{labels:labels, datasets:[{data:values}]}});
}

function updateProgressChart(member) {
  const total = sheetsData["Total"];
  const row = total.find(r=>r["Name"]===member);
  if(!row) return;
  const labels = Object.keys(row).filter(k=>k!=="Name" && k!=="Points");
  const values = labels.map(l=>parseInt(row[l])||0);
  let cum=0, cumValues=[];
  values.forEach(v=>{ cum+=v; cumValues.push(cum); });
  if(progressChart) progressChart.destroy();
  progressChart = new Chart(document.getElementById("progressChart"),{
    type:"line",
    data:{labels:labels, datasets:[{label:"Cumulative Points", data:cumValues}]}
  });
}

init();
</script>
</body>
</html>
